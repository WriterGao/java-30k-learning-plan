# 第2章：Java内存区域与内存溢出异常 - 知识点框架

> **重要更新**：本仓库已提供 `00-教学课件_JVM内存模型详解.md`（导师定制，图文并茂），**完全替代《深入理解Java虚拟机》第2章**。  
> 本文件提供知识点快速参考，配合课件使用。

---

## 📚 核心知识点速查

### 1. JVM运行时数据区全景

**线程私有区域**：
- 程序计数器（PC Register）
- Java虚拟机栈（JVM Stack）
- 本地方法栈（Native Method Stack）

**线程共享区域**：
- Java堆（Java Heap）
- 方法区/元空间（Method Area / Metaspace）
- 直接内存（Direct Memory）

**详细讲解**：参考课件第1章

---

### 2. 程序计数器（PC Register）

**核心要点**：
- ✅ 唯一不会发生OutOfMemoryError的区域
- ✅ 线程私有
- ✅ 记录当前线程执行的字节码指令地址
- ✅ 执行Native方法时值为空（Undefined）

**详细讲解**：参考课件第2章

---

### 3. Java虚拟机栈（JVM Stack）

**核心要点**：
- ✅ 线程私有
- ✅ 存储方法调用的栈帧
- ✅ 栈帧包含：局部变量表、操作数栈、动态链接、方法返回地址
- ✅ 异常：StackOverflowError（栈深度超限）、OutOfMemoryError（无法扩展栈）

**详细讲解**：参考课件第3章

---

### 4. 本地方法栈（Native Method Stack）

**核心要点**：
- ✅ 线程私有
- ✅ 为Native方法服务
- ✅ HotSpot将本地方法栈和Java虚拟机栈合二为一

**详细讲解**：参考课件第4章

---

### 5. Java堆（Java Heap）

**核心要点**：
- ✅ 线程共享
- ✅ GC的主要区域
- ✅ 分区：
  - 新生代（Young Generation）：Eden区 + Survivor区
  - 老年代（Old Generation）
- ✅ 异常：OutOfMemoryError: Java heap space

**详细讲解**：参考课件第5章

---

### 6. 方法区/元空间（Method Area / Metaspace）

**核心要点**：
- ✅ 线程共享
- ✅ 存储：类信息、常量池、静态变量、即时编译器编译后的代码
- ✅ 版本差异：
  - JDK 7及以前：永久代（PermGen），在Java堆中
  - JDK 8及以后：元空间（Metaspace），在本地内存中
- ✅ 异常：OutOfMemoryError: PermGen space（JDK 7）或 Metaspace（JDK 8+）

**详细讲解**：参考课件第6章

---

### 7. 运行时常量池（Runtime Constant Pool）

**核心要点**：
- ✅ 属于方法区的一部分
- ✅ 存储：字面量、符号引用
- ✅ 动态性：运行期间可以将新的常量放入池中（如String.intern()）

**详细讲解**：参考课件第7章

---

### 8. 直接内存（Direct Memory）

**核心要点**：
- ✅ NIO使用Native函数库直接分配堆外内存
- ✅ 不受Java堆大小限制
- ✅ 受本机总内存和处理器寻址空间限制
- ✅ 异常：OutOfMemoryError: Direct buffer memory

**详细讲解**：参考课件第8章

---

### 9. 对象创建全过程

**5个步骤**：
1. 检查类是否已加载
2. 分配内存（指针碰撞/空闲列表）
3. 内存空间初始化（零值）
4. 设置对象头（Mark Word、类型指针等）
5. 执行init方法（构造函数）

**对象内存布局**：
- 对象头（Header）：Mark Word、类型指针、数组长度
- 实例数据（Instance Data）
- 对齐填充（Padding）

**详细讲解**：参考课件第9章

---

### 10. 内存溢出异常分析

**堆内存溢出**：
- 异常：`java.lang.OutOfMemoryError: Java heap space`
- 触发条件：不断创建对象，且对象无法被GC回收
- 复现代码：`code/HeapOomDemo.java`

**栈溢出**：
- 异常：`java.lang.StackOverflowError`
- 触发条件：栈深度超过虚拟机允许的最大深度
- 复现代码：`code/StackOverflowDemo.java`

**方法区溢出**：
- JDK 7：`java.lang.OutOfMemoryError: PermGen space`
- JDK 8+：`java.lang.OutOfMemoryError: Metaspace`
- 触发条件：类加载过多

**详细讲解**：参考课件第10章

---

## 🎯 学习检查清单

### 基础理解
- [ ] 能画出JVM运行时数据区的完整结构图
- [ ] 能说出每个区域的作用、线程私有/共享属性、生命周期
- [ ] 能解释为什么程序计数器不会发生OOM
- [ ] 能区分StackOverflowError和OutOfMemoryError的触发场景

### 深入理解
- [ ] 能解释堆内存分代的原因和GC的关系
- [ ] 能说出方法区在不同JDK版本中的实现差异（永久代 vs 元空间）
- [ ] 能解释对象创建的完整流程（从new到可用）
- [ ] 能说出对象内存布局（对象头、实例数据、对齐填充）

### 实战能力
- [ ] 能通过代码复现堆内存溢出
- [ ] 能通过代码复现栈溢出
- [ ] 能使用jvisualvm观察内存使用情况
- [ ] 能分析GC日志，找出内存问题
- [ ] 能配置JVM参数（-Xms、-Xmx、-Xss等）

**详细检查清单**：参考课件第11.2节

---

## 📝 面试高频问题

### Q1: JVM内存区域有哪些？哪些是线程私有的？

**A**: JVM内存区域包括：
- 线程私有：程序计数器、Java虚拟机栈、本地方法栈
- 线程共享：Java堆、方法区/元空间、直接内存

**详细答案**：参考课件第11.3节

### Q2: 堆和栈的区别？

**A**: 
- 堆：线程共享，存储对象实例，GC主要区域，生命周期与JVM相同
- 栈：线程私有，存储方法调用的栈帧，方法结束即销毁，生命周期与线程相同

**详细答案**：参考课件第11.3节

### Q3: 对象创建的过程？

**A**: 
1. 检查类是否已加载
2. 分配内存（指针碰撞或空闲列表）
3. 初始化零值
4. 设置对象头（Mark Word、类型指针等）
5. 执行init方法（构造函数）

**详细答案**：参考课件第9章和第11.3节

### Q4: 什么情况下会发生堆内存溢出？

**A**: 
- 不断创建对象，且对象无法被GC回收
- 常见原因：内存泄漏、对象生命周期过长、堆内存设置过小

**详细答案**：参考课件第10.1节和第11.3节

### Q5: 永久代和元空间的区别？

**A**: 
- 永久代（JDK 7及以前）：在Java堆中，受-XX:MaxPermSize限制
- 元空间（JDK 8及以后）：在本地内存中，受系统可用内存限制，更灵活

**详细答案**：参考课件第6章和第11.3节

---

## 🔗 相关资源

- **核心课件**：`00-教学课件_JVM内存模型详解.md`（必读）
- **阅读导学**：`01-阅读导学_第2章.md`
- **学习笔记模板**：`02-学习笔记.md`
- **实验指导**：`03-实验与练习.md`
- **实验代码**：`code/` 目录

---

## 📚 常用JVM参数速查

```bash
# 堆内存
-Xms512m              # 初始堆大小
-Xmx1024m             # 最大堆大小
-Xmn256m              # 新生代大小

# 栈内存
-Xss1m                # 每个线程的栈大小

# 方法区/元空间
-XX:PermSize=256m     # 永久代初始大小（JDK 7）
-XX:MaxPermSize=512m  # 永久代最大大小（JDK 7）
-XX:MetaspaceSize=256m    # 元空间初始大小（JDK 8+）
-XX:MaxMetaspaceSize=512m # 元空间最大大小（JDK 8+）

# GC日志
-XX:+PrintGCDetails           # 打印GC详细信息
-XX:+PrintGCDateStamps        # 打印GC时间戳
-Xloggc:gc.log                # GC日志文件
-XX:+HeapDumpOnOutOfMemoryError # OOM时生成堆转储
-XX:HeapDumpPath=./heap.hprof  # 堆转储文件路径

# 直接内存
-XX:MaxDirectMemorySize=128m   # 直接内存最大大小
```

**详细参数说明**：参考课件附录

---

> **提示**：本文件仅提供知识点快速参考，详细讲解请阅读 `00-教学课件_JVM内存模型详解.md`。
