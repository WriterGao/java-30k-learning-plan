# Day06 学习笔记

> **学习目标**：今天的笔记目标是"**能复述、能画图、能用代码验证**"，不要抄书。  
> **参考课件**：`00-教学课件_线程池原理与实战详解.md`

---

## 1. 为什么需要线程池（用你自己的话）

### 1.1 不使用线程池的问题

请列举直接 `new Thread()` 的 3 个主要问题：

1. 
2. 
3. 

### 1.2 线程池的核心优势

- **资源复用**：
- **控制并发**：
- **管理生命周期**：

---

## 2. ThreadPoolExecutor 7 个核心参数

### 2.1 参数一览

请填写每个参数的含义和作用：

| 参数 | 类型 | 含义 | 你的理解 |
|------|------|------|---------|
| corePoolSize | int | | |
| maximumPoolSize | int | | |
| keepAliveTime | long | | |
| unit | TimeUnit | | |
| workQueue | BlockingQueue | | |
| threadFactory | ThreadFactory | | |
| handler | RejectedExecutionHandler | | |

### 2.2 参数之间的关系

请用一个比喻来解释这 7 个参数的关系（如：银行窗口模型）：

```
（在此写你的比喻）
```

### 2.3 corePoolSize vs maximumPoolSize

- **什么时候创建核心线程**：
- **什么时候创建非核心线程**：
- **非核心线程什么时候销毁**：
- **核心线程会被销毁吗**：

---

## 3. 线程池工作流程

### 3.1 任务提交流程

请画出任务提交的完整流程图（可用 ASCII 或文字描述）：

```
（在此画图）
```

### 3.2 关键判断节点

1. 任务提交时，首先判断什么？
   - 
2. 如果核心线程满了，下一步做什么？
   - 
3. 如果队列也满了，下一步做什么？
   - 
4. 如果最大线程也满了，最终怎么处理？
   - 

---

## 4. 拒绝策略

### 4.1 四种拒绝策略对比

| 策略 | 行为 | 适用场景 | 你的理解 |
|------|------|---------|---------|
| AbortPolicy | | | |
| CallerRunsPolicy | | | |
| DiscardPolicy | | | |
| DiscardOldestPolicy | | | |

### 4.2 默认拒绝策略是哪个？

- 

### 4.3 自定义拒绝策略场景

- **什么时候需要自定义**：
- **你会怎么实现**（如：记录日志、持久化到数据库等）：

---

## 5. 工作队列

### 5.1 常用队列对比

| 队列 | 是否有界 | 特点 | 适用场景 |
|------|---------|------|---------|
| ArrayBlockingQueue | | | |
| LinkedBlockingQueue | | | |
| SynchronousQueue | | | |
| PriorityBlockingQueue | | | |

### 5.2 队列选择对线程池行为的影响

- **有界队列 + 合适的 maximumPoolSize**：
- **无界队列（LinkedBlockingQueue）的风险**：
- **SynchronousQueue 的特殊行为**：

---

## 6. Executors 工厂方法

### 6.1 四种预定义线程池

| 方法 | 参数配置 | 队列类型 | 问题 |
|------|---------|---------|------|
| newFixedThreadPool | | | |
| newSingleThreadExecutor | | | |
| newCachedThreadPool | | | |
| newScheduledThreadPool | | | |

### 6.2 阿里规范为什么禁止使用 Executors？

请用自己的话解释：

- **FixedThreadPool/SingleThreadExecutor 的问题**：
- **CachedThreadPool 的问题**：
- **应该怎么创建线程池**：

---

## 7. 线程池状态与生命周期

### 7.1 五种状态

请填写每种状态的含义和行为：

| 状态 | 含义 | 是否接受新任务 | 是否处理队列任务 | 是否中断执行中任务 |
|------|------|:---:|:---:|:---:|
| RUNNING | | | | |
| SHUTDOWN | | | | |
| STOP | | | | |
| TIDYING | | | | |
| TERMINATED | | | | |

### 7.2 状态转换

请写出状态转换的触发条件：

```
RUNNING → SHUTDOWN：调用 ?
RUNNING → STOP：调用 ?
SHUTDOWN → TIDYING：? 时
STOP → TIDYING：? 时
TIDYING → TERMINATED：? 执行完毕
```

### 7.3 shutdown vs shutdownNow

| 对比维度 | shutdown() | shutdownNow() |
|---------|-----------|---------------|
| 新任务 | | |
| 队列任务 | | |
| 执行中任务 | | |
| 返回值 | | |

---

## 8. execute vs submit

### 8.1 对比分析

| 对比维度 | execute() | submit() |
|---------|----------|----------|
| 返回值 | | |
| 参数类型 | | |
| 异常处理 | | |
| 所属接口 | | |

### 8.2 submit 的异常丢失问题

- **问题描述**：
- **解决方案**：

---

## 9. 线程池源码分析

### 9.1 ctl 变量的设计

- **高 3 位表示什么**：
- **低 29 位表示什么**：
- **为什么这样设计**：

### 9.2 execute 方法的核心逻辑

请用自己的话描述 execute 方法的 3 个 if 判断：

1. 
2. 
3. 

### 9.3 addWorker 方法

- **作用**：
- **core 参数的含义**：
- **创建 Worker 的过程**：

### 9.4 runWorker 方法

- **Worker 的执行循环**：
- **getTask 的作用**：
- **线程如何被回收**：

---

## 10. 线程池最佳实践

### 10.1 线程数设置

- **CPU 密集型公式**：
- **IO 密集型公式**：
- **为什么要区分**：
- **你的机器 CPU 核心数**：________

### 10.2 动态调整线程池参数

- **setCorePoolSize 的效果**：
- **setMaximumPoolSize 的效果**：
- **美团的实践方案**：

---

## 11. ScheduledThreadPoolExecutor

### 11.1 与 Timer 的区别

| 对比维度 | Timer | ScheduledThreadPoolExecutor |
|---------|-------|---------------------------|
| 线程数 | | |
| 异常处理 | | |
| 任务调度 | | |
| 精度 | | |

### 11.2 核心方法

- **schedule**：
- **scheduleAtFixedRate**：
- **scheduleWithFixedDelay**：
- **两种周期方式的区别**：

---

## 12. ForkJoinPool

### 12.1 工作窃取算法

- **是什么**：
- **为什么需要**：
- **怎么实现的**：

### 12.2 RecursiveTask vs RecursiveAction

| 类型 | 返回值 | 用途 |
|------|--------|------|
| RecursiveTask | | |
| RecursiveAction | | |

### 12.3 fork/join 的执行流程

1. 
2. 
3. 
4. 

---

## 13. 手写简易线程池

### 13.1 核心组件

- **任务队列**：
- **Worker 线程**：
- **提交任务方法**：
- **关闭方法**：

### 13.2 你对 SimpleThreadPool.java 的理解

请用自己的话描述手写线程池的工作原理：

```
（在此描述）
```

---

## 14. 5 分钟复述稿（面试式）

用 5 分钟讲清楚"线程池原理"，要求：
- 先总览，再逐一解释，再给关键实现细节

**我的复述稿**：

```
【为什么需要线程池】
线程池是一种池化技术，主要解决...

【7 个核心参数】
ThreadPoolExecutor 有 7 个核心参数...

【工作流程】
任务提交时，首先判断核心线程数...

【拒绝策略】
当线程池满了，有 4 种拒绝策略...

【源码分析】
execute 方法有 3 个关键判断...
ctl 变量的巧妙设计...

【最佳实践】
CPU 密集型设置 N+1...
IO 密集型设置 2N...

【实际应用】
举一个你在项目中使用线程池的例子...
```

---

## 15. 学习总结与疑问

### 15.1 今天学到的核心知识点

1. 
2. 
3. 
4. 
5. 

### 15.2 还有疑问的地方

1. 
2. 

### 15.3 下一步学习计划

- [ ] 复习课件的检查清单
- [ ] 阅读 ThreadPoolExecutor 源码
- [ ] 准备下一天的学习

---

> **提示**：完成笔记后，对照课件最后一章的检查清单进行自我验收。
