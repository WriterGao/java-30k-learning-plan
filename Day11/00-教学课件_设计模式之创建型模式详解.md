# è®¾è®¡æ¨¡å¼ä¹‹åˆ›å»ºå‹æ¨¡å¼è¯¦è§£

> **å­¦ä¹ ç›®æ ‡**ï¼šæ·±å…¥ç†è§£ GOF 23 ç§è®¾è®¡æ¨¡å¼ä¸­çš„ 5 ç§åˆ›å»ºå‹æ¨¡å¼ï¼ˆå•ä¾‹ã€å·¥å‚æ–¹æ³•ã€æŠ½è±¡å·¥å‚ã€å»ºé€ è€…ã€åŸå‹ï¼‰ï¼ŒæŒæ¡ 7 å¤§è®¾è®¡åŸåˆ™ï¼Œèƒ½åœ¨å®é™…é¡¹ç›®å’Œé¢è¯•ä¸­çµæ´»è¿ç”¨ã€‚

---

## ç›®å½•

- [ä¸€ã€è®¾è®¡æ¨¡å¼æ¦‚è¿°](#ä¸€è®¾è®¡æ¨¡å¼æ¦‚è¿°)
  - [1.1 ä»€ä¹ˆæ˜¯è®¾è®¡æ¨¡å¼](#11-ä»€ä¹ˆæ˜¯è®¾è®¡æ¨¡å¼)
  - [1.2 GOF 23 ç§è®¾è®¡æ¨¡å¼åˆ†ç±»](#12-gof-23-ç§è®¾è®¡æ¨¡å¼åˆ†ç±»)
  - [1.3 ä¸ƒå¤§è®¾è®¡åŸåˆ™](#13-ä¸ƒå¤§è®¾è®¡åŸåˆ™)
- [äºŒã€å•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰](#äºŒå•ä¾‹æ¨¡å¼singleton)
- [ä¸‰ã€å·¥å‚æ¨¡å¼ï¼ˆFactoryï¼‰](#ä¸‰å·¥å‚æ¨¡å¼factory)
- [å››ã€å»ºé€ è€…æ¨¡å¼ï¼ˆBuilderï¼‰](#å››å»ºé€ è€…æ¨¡å¼builder)
- [äº”ã€åŸå‹æ¨¡å¼ï¼ˆPrototypeï¼‰](#äº”åŸå‹æ¨¡å¼prototype)
- [å…­ã€åˆ›å»ºå‹æ¨¡å¼åœ¨ Spring/JDK ä¸­çš„åº”ç”¨æ€»ç»“](#å…­åˆ›å»ºå‹æ¨¡å¼åœ¨-springjdk-ä¸­çš„åº”ç”¨æ€»ç»“)
- [ä¸ƒã€é¢è¯•é«˜é¢‘é—®é¢˜](#ä¸ƒé¢è¯•é«˜é¢‘é—®é¢˜)

---

# ä¸€ã€è®¾è®¡æ¨¡å¼æ¦‚è¿°

## 1.1 ä»€ä¹ˆæ˜¯è®¾è®¡æ¨¡å¼

**è®¾è®¡æ¨¡å¼ï¼ˆDesign Patternï¼‰** æ˜¯å‰äººåœ¨å¤§é‡è½¯ä»¶å¼€å‘å®è·µä¸­æ€»ç»“å‡ºæ¥çš„ã€è¢«åå¤éªŒè¯çš„ã€å¯å¤ç”¨çš„é¢å‘å¯¹è±¡è®¾è®¡ç»éªŒã€‚å®ƒä¸æ˜¯å…·ä½“çš„ä»£ç ï¼Œè€Œæ˜¯è§£å†³ç‰¹å®šé—®é¢˜çš„**é€šç”¨æ–¹æ¡ˆæ¨¡æ¿**ã€‚

> "æ¯ä¸€ä¸ªæ¨¡å¼æè¿°äº†ä¸€ä¸ªåœ¨æˆ‘ä»¬å‘¨å›´ä¸æ–­é‡å¤å‘ç”Ÿçš„é—®é¢˜ï¼Œä»¥åŠè¯¥é—®é¢˜çš„è§£å†³æ–¹æ¡ˆçš„æ ¸å¿ƒã€‚è¿™æ ·ï¼Œä½ å°±èƒ½ä¸€æ¬¡åˆä¸€æ¬¡åœ°ä½¿ç”¨è¯¥æ–¹æ¡ˆè€Œä¸å¿…åšé‡å¤åŠ³åŠ¨ã€‚"
> â€”â€” Christopher Alexander

### è®¾è®¡æ¨¡å¼çš„æ ¸å¿ƒä»·å€¼

1. **å¤ç”¨æ€§**ï¼šæä¾›ç»è¿‡éªŒè¯çš„è§£å†³æ–¹æ¡ˆï¼Œé¿å…é‡å¤é€ è½®å­
2. **å¯è¯»æ€§**ï¼šä½¿ç”¨çº¦å®šçš„æœ¯è¯­ï¼ˆå¦‚"å•ä¾‹""å·¥å‚"ï¼‰ï¼Œæé«˜å›¢é˜Ÿæ²Ÿé€šæ•ˆç‡
3. **å¯ç»´æŠ¤æ€§**ï¼šéµå¾ªè®¾è®¡åŸåˆ™ï¼Œä½¿ä»£ç æ›´å®¹æ˜“ä¿®æ”¹å’Œæ‰©å±•
4. **å¯é æ€§**ï¼šç»è¿‡æ— æ•°é¡¹ç›®æ£€éªŒï¼Œé™ä½å‡ºé”™æ¦‚ç‡

### è®¾è®¡æ¨¡å¼çš„ä¸‰è¦ç´ 

| è¦ç´  | è¯´æ˜ |
|------|------|
| **æ¨¡å¼åç§°** | ç”¨ä¸€ä¸¤ä¸ªè¯è¡¨è¾¾è®¾è®¡æ„å›¾ï¼ˆå¦‚ Singletonã€Factoryï¼‰ |
| **é—®é¢˜** | æè¿°åœ¨ä½•ç§åœºæ™¯ä¸‹ä½¿ç”¨è¯¥æ¨¡å¼ |
| **è§£å†³æ–¹æ¡ˆ** | æè¿°è®¾è®¡çš„å„ç»„æˆéƒ¨åˆ†åŠå…¶å…³ç³»ã€èŒè´£å’Œåä½œæ–¹å¼ |

---

## 1.2 GOF 23 ç§è®¾è®¡æ¨¡å¼åˆ†ç±»

GOFï¼ˆGang of Fourï¼‰åœ¨ 1994 å¹´å‡ºç‰ˆçš„ã€ŠDesign Patterns: Elements of Reusable Object-Oriented Softwareã€‹ä¸­å®šä¹‰äº† 23 ç§ç»å…¸è®¾è®¡æ¨¡å¼ï¼ŒæŒ‰**ç›®çš„**åˆ†ä¸ºä¸‰ç±»ï¼š

```mermaid
graph TB
    A[GOF 23 ç§è®¾è®¡æ¨¡å¼] --> B[åˆ›å»ºå‹æ¨¡å¼<br/>Creational]
    A --> C[ç»“æ„å‹æ¨¡å¼<br/>Structural]
    A --> D[è¡Œä¸ºå‹æ¨¡å¼<br/>Behavioral]
    
    B --> B1[å•ä¾‹ Singleton]
    B --> B2[å·¥å‚æ–¹æ³• Factory Method]
    B --> B3[æŠ½è±¡å·¥å‚ Abstract Factory]
    B --> B4[å»ºé€ è€… Builder]
    B --> B5[åŸå‹ Prototype]
    
    C --> C1[é€‚é…å™¨ Adapter]
    C --> C2[æ¡¥æ¥ Bridge]
    C --> C3[ç»„åˆ Composite]
    C --> C4[è£…é¥°å™¨ Decorator]
    C --> C5[å¤–è§‚ Facade]
    C --> C6[äº«å…ƒ Flyweight]
    C --> C7[ä»£ç† Proxy]
    
    D --> D1[æ¨¡æ¿æ–¹æ³• Template Method]
    D --> D2[ç­–ç•¥ Strategy]
    D --> D3[è§‚å¯Ÿè€… Observer]
    D --> D4[è´£ä»»é“¾ Chain of Responsibility]
    D --> D5[å‘½ä»¤ Command]
    D --> D6[è¿­ä»£å™¨ Iterator]
    D --> D7[ä¸­ä»‹è€… Mediator]
    D --> D8[å¤‡å¿˜å½• Memento]
    D --> D9[çŠ¶æ€ State]
    D --> D10[è®¿é—®è€… Visitor]
    D --> D11[è§£é‡Šå™¨ Interpreter]
    
    style B fill:#e1f5fe
    style C fill:#f3e5f5
    style D fill:#e8f5e9
```

### ä¸‰ç±»æ¨¡å¼å¯¹æ¯”

| åˆ†ç±» | å…³æ³¨ç‚¹ | æ ¸å¿ƒæ€æƒ³ | åŒ…å«æ¨¡å¼ |
|------|--------|----------|----------|
| **åˆ›å»ºå‹** | å¯¹è±¡çš„**åˆ›å»ºè¿‡ç¨‹** | å°†å¯¹è±¡çš„åˆ›å»ºä¸ä½¿ç”¨åˆ†ç¦»ï¼Œéšè—åˆ›å»ºç»†èŠ‚ | å•ä¾‹ã€å·¥å‚æ–¹æ³•ã€æŠ½è±¡å·¥å‚ã€å»ºé€ è€…ã€åŸå‹ |
| **ç»“æ„å‹** | ç±»å’Œå¯¹è±¡çš„**ç»„åˆæ–¹å¼** | é€šè¿‡ç»„åˆè·å¾—æ›´å¤§çš„ç»“æ„ï¼Œä¿æŒç»“æ„çµæ´»é«˜æ•ˆ | é€‚é…å™¨ã€æ¡¥æ¥ã€ç»„åˆã€è£…é¥°å™¨ã€å¤–è§‚ã€äº«å…ƒã€ä»£ç† |
| **è¡Œä¸ºå‹** | å¯¹è±¡ä¹‹é—´çš„**èŒè´£åˆ†é…å’Œé€šä¿¡** | æè¿°å¯¹è±¡ä¹‹é—´æ€æ ·åä½œå®Œæˆå•ä¸ªå¯¹è±¡æ— æ³•å®Œæˆçš„ä»»åŠ¡ | æ¨¡æ¿æ–¹æ³•ã€ç­–ç•¥ã€è§‚å¯Ÿè€…ã€è´£ä»»é“¾ã€å‘½ä»¤ã€è¿­ä»£å™¨ã€ä¸­ä»‹è€…ã€å¤‡å¿˜å½•ã€çŠ¶æ€ã€è®¿é—®è€…ã€è§£é‡Šå™¨ |

> **æœ¬èŠ‚é‡ç‚¹**ï¼šåˆ›å»ºå‹æ¨¡å¼ã€‚åˆ›å»ºå‹æ¨¡å¼çš„æ ¸å¿ƒç›®æ ‡æ˜¯**"å°†å¯¹è±¡çš„åˆ›å»ºä¸ä½¿ç”¨è§£è€¦"**ï¼Œè®©å®¢æˆ·ç«¯ä¸éœ€è¦å…³å¿ƒå¯¹è±¡æ˜¯å¦‚ä½•è¢«åˆ›å»ºçš„ã€‚

---

## 1.3 ä¸ƒå¤§è®¾è®¡åŸåˆ™

è®¾è®¡åŸåˆ™æ˜¯è®¾è®¡æ¨¡å¼çš„**ç†è®ºåŸºçŸ³**ã€‚æ‰€æœ‰çš„è®¾è®¡æ¨¡å¼éƒ½æ˜¯ä¸ºäº†æ›´å¥½åœ°éµå¾ªè¿™äº›åŸåˆ™ã€‚

```mermaid
graph TB
    A[ä¸ƒå¤§è®¾è®¡åŸåˆ™] --> B[å•ä¸€èŒè´£åŸåˆ™ SRP]
    A --> C[å¼€é—­åŸåˆ™ OCP]
    A --> D[é‡Œæ°æ›¿æ¢åŸåˆ™ LSP]
    A --> E[ä¾èµ–å€’ç½®åŸåˆ™ DIP]
    A --> F[æ¥å£éš”ç¦»åŸåˆ™ ISP]
    A --> G[è¿ªç±³ç‰¹æ³•åˆ™ LoD]
    A --> H[åˆæˆå¤ç”¨åŸåˆ™ CRP]
    
    style A fill:#fff3e0
    style C fill:#ffcdd2
```

### 1.3.1 å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRP - Single Responsibility Principleï¼‰

> **å®šä¹‰**ï¼šä¸€ä¸ªç±»åº”è¯¥åªæœ‰ä¸€ä¸ªå¼•èµ·å®ƒå˜åŒ–çš„åŸå› ï¼ˆå³åªè´Ÿè´£ä¸€é¡¹èŒè´£ï¼‰ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼šå¦‚æœä¸€ä¸ªç±»æ‰¿æ‹…äº†å¤šä¸ªèŒè´£ï¼Œå½“å…¶ä¸­ä¸€ä¸ªèŒè´£å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¯èƒ½ä¼šå½±å“åˆ°å…¶ä»–èŒè´£çš„æ­£å¸¸è¿è¡Œã€‚

**åé¢ç¤ºä¾‹**ï¼šä¸€ä¸ªç±»åŒæ—¶å¤„ç†ç”¨æˆ·ä¿¡æ¯å’Œè®¢å•é€»è¾‘

```java
// âŒ è¿åå•ä¸€èŒè´£ï¼šä¸€ä¸ªç±»åŒæ—¶ç®¡ç†ç”¨æˆ·æ•°æ®å’Œå‘é€é‚®ä»¶
public class UserService {
    public void saveUser(User user) {
        // ä¿å­˜ç”¨æˆ·åˆ°æ•°æ®åº“
        String sql = "INSERT INTO users ...";
        // JDBC æ“ä½œ...
    }
    
    public void sendEmail(User user, String content) {
        // å‘é€é‚®ä»¶é€šçŸ¥
        // SMTP æ“ä½œ...
    }
    
    public String generateReport(User user) {
        // ç”Ÿæˆç”¨æˆ·æŠ¥å‘Š
        // æŠ¥å‘Šç”Ÿæˆé€»è¾‘...
        return "report";
    }
}
```

**æ­£é¢ç¤ºä¾‹**ï¼šæ‹†åˆ†ä¸ºå„è‡ªèŒè´£æ˜ç¡®çš„ç±»

```java
// âœ… éµå¾ªå•ä¸€èŒè´£
public class UserRepository {
    public void saveUser(User user) {
        // åªè´Ÿè´£ç”¨æˆ·æ•°æ®æŒä¹…åŒ–
        String sql = "INSERT INTO users ...";
    }
}

public class EmailService {
    public void sendEmail(User user, String content) {
        // åªè´Ÿè´£é‚®ä»¶å‘é€
    }
}

public class ReportService {
    public String generateUserReport(User user) {
        // åªè´Ÿè´£æŠ¥å‘Šç”Ÿæˆ
        return "report";
    }
}
```

**å®é™…åº”ç”¨**ï¼š
- Spring MVC ä¸­çš„ Controller â†’ Service â†’ Repository åˆ†å±‚å°±æ˜¯ SRP çš„ä½“ç°
- æ¯ä¸€å±‚åªå…³æ³¨è‡ªå·±çš„èŒè´£ï¼šController å¤„ç†è¯·æ±‚ã€Service å¤„ç†ä¸šåŠ¡é€»è¾‘ã€Repository å¤„ç†æ•°æ®è®¿é—®

---

### 1.3.2 å¼€é—­åŸåˆ™ï¼ˆOCP - Open/Closed Principleï¼‰

> **å®šä¹‰**ï¼šè½¯ä»¶å®ä½“ï¼ˆç±»ã€æ¨¡å—ã€å‡½æ•°ç­‰ï¼‰åº”è¯¥**å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­**ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼šå½“éœ€æ±‚å˜åŒ–æ—¶ï¼Œé€šè¿‡**æ–°å¢ä»£ç **æ¥æ‰©å±•åŠŸèƒ½ï¼Œè€Œä¸æ˜¯**ä¿®æ”¹å·²æœ‰ä»£ç **ã€‚è¿™æ˜¯æ‰€æœ‰è®¾è®¡åŸåˆ™ä¸­**æœ€é‡è¦**çš„ä¸€æ¡ã€‚

**åé¢ç¤ºä¾‹**ï¼šç”¨ if-else åˆ¤æ–­ç±»å‹ï¼Œæ¯å¢åŠ ä¸€ç§ç±»å‹å°±è¦ä¿®æ”¹ä»£ç 

```java
// âŒ è¿åå¼€é—­åŸåˆ™ï¼šæ¯æ–°å¢ä¸€ç§å›¾å½¢ï¼Œéƒ½è¦ä¿®æ”¹ drawShape æ–¹æ³•
public class GraphicEditor {
    public void drawShape(String type) {
        if ("circle".equals(type)) {
            drawCircle();
        } else if ("rectangle".equals(type)) {
            drawRectangle();
        } else if ("triangle".equals(type)) {
            // æ–°å¢ä¸‰è§’å½¢éœ€è¦ä¿®æ”¹æ­¤æ–¹æ³•
            drawTriangle();
        }
    }
    
    private void drawCircle() { System.out.println("ç”»åœ†å½¢"); }
    private void drawRectangle() { System.out.println("ç”»çŸ©å½¢"); }
    private void drawTriangle() { System.out.println("ç”»ä¸‰è§’å½¢"); }
}
```

**æ­£é¢ç¤ºä¾‹**ï¼šé€šè¿‡æŠ½è±¡ + å¤šæ€å®ç°å¼€é—­åŸåˆ™

```java
// âœ… éµå¾ªå¼€é—­åŸåˆ™ï¼šæ–°å¢å›¾å½¢åªéœ€å¢åŠ æ–°ç±»ï¼Œæ— éœ€ä¿®æ”¹å·²æœ‰ä»£ç 
public interface Shape {
    void draw();
}

public class Circle implements Shape {
    @Override
    public void draw() { System.out.println("ç”»åœ†å½¢"); }
}

public class Rectangle implements Shape {
    @Override
    public void draw() { System.out.println("ç”»çŸ©å½¢"); }
}

// æ–°å¢ä¸‰è§’å½¢ï¼šåªéœ€æ–°å¢ä¸€ä¸ªç±»ï¼Œä¸ä¿®æ”¹ä»»ä½•å·²æœ‰ä»£ç 
public class Triangle implements Shape {
    @Override
    public void draw() { System.out.println("ç”»ä¸‰è§’å½¢"); }
}

public class GraphicEditor {
    public void drawShape(Shape shape) {
        shape.draw(); // é¢å‘æ¥å£ç¼–ç¨‹ï¼Œå¯¹æ‰©å±•å¼€æ”¾
    }
}
```

**å®é™…åº”ç”¨**ï¼š
- Java çš„ `java.util.Collections.sort()` é€šè¿‡ `Comparator` æ¥å£æ‰©å±•æ’åºé€»è¾‘
- Spring ä¸­å¤§é‡ä½¿ç”¨ç­–ç•¥æ¨¡å¼å®ç° OCP

---

### 1.3.3 é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆLSP - Liskov Substitution Principleï¼‰

> **å®šä¹‰**ï¼šæ‰€æœ‰å¼•ç”¨åŸºç±»çš„åœ°æ–¹å¿…é¡»èƒ½é€æ˜åœ°ä½¿ç”¨å…¶å­ç±»çš„å¯¹è±¡ï¼Œè€Œä¸ä¼šäº§ç”Ÿä»»ä½•é”™è¯¯æˆ–å¼‚å¸¸ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼šå­ç±»å¯ä»¥æ‰©å±•çˆ¶ç±»çš„åŠŸèƒ½ï¼Œä½†ä¸åº”è¯¥æ”¹å˜çˆ¶ç±»åŸæœ‰çš„åŠŸèƒ½ã€‚

**åé¢ç¤ºä¾‹**ï¼šç»å…¸çš„æ­£æ–¹å½¢-é•¿æ–¹å½¢é—®é¢˜

```java
// âŒ è¿åé‡Œæ°æ›¿æ¢åŸåˆ™
public class Rectangle {
    protected int width;
    protected int height;
    
    public void setWidth(int width) { this.width = width; }
    public void setHeight(int height) { this.height = height; }
    public int getArea() { return width * height; }
}

// æ­£æ–¹å½¢ç»§æ‰¿é•¿æ–¹å½¢
public class Square extends Rectangle {
    @Override
    public void setWidth(int width) {
        this.width = width;
        this.height = width; // æ­£æ–¹å½¢è¦æ±‚å®½é«˜ä¸€è‡´ï¼Œä¿®æ”¹äº†çˆ¶ç±»è¡Œä¸ºï¼
    }
    
    @Override
    public void setHeight(int height) {
        this.width = height;
        this.height = height;
    }
}

// ä½¿ç”¨çˆ¶ç±»å¼•ç”¨
public void resize(Rectangle r) {
    while (r.getArea() < 100) {
        r.setWidth(r.getWidth() + 1);
        // å¦‚æœä¼ å…¥ Squareï¼Œå°†æ— é™å¾ªç¯ï¼å› ä¸º setWidth åŒæ—¶æ”¹äº† height
    }
}
```

**æ­£é¢ç¤ºä¾‹**ï¼šç”¨æŠ½è±¡è§£å†³ç»§æ‰¿é—®é¢˜

```java
// âœ… éµå¾ªé‡Œæ°æ›¿æ¢åŸåˆ™ï¼šæå–å…¬å…±æŠ½è±¡
public interface Shape {
    int getArea();
}

public class Rectangle implements Shape {
    private int width;
    private int height;
    
    public Rectangle(int width, int height) {
        this.width = width;
        this.height = height;
    }
    
    @Override
    public int getArea() { return width * height; }
}

public class Square implements Shape {
    private int side;
    
    public Square(int side) {
        this.side = side;
    }
    
    @Override
    public int getArea() { return side * side; }
}
```

**å®é™…åº”ç”¨**ï¼š
- Java é›†åˆæ¡†æ¶ä¸­ `List`ã€`Set` ç»§æ‰¿ `Collection`ï¼Œå®ƒä»¬çš„å®ç°ç±»éƒ½å¯ä»¥æ›¿ä»£çˆ¶æ¥å£ä½¿ç”¨
- å¦‚æœä½ è¦†ç›–äº†çˆ¶ç±»æ–¹æ³•å¹¶æ”¹å˜äº†å…¶è¯­ä¹‰ï¼Œå°±è¿åäº† LSP

---

### 1.3.4 ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIP - Dependency Inversion Principleï¼‰

> **å®šä¹‰**ï¼š
> 1. é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—ï¼ŒäºŒè€…éƒ½åº”è¯¥ä¾èµ–æŠ½è±¡
> 2. æŠ½è±¡ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚ï¼Œç»†èŠ‚åº”è¯¥ä¾èµ–æŠ½è±¡

**æ ¸å¿ƒæ€æƒ³**ï¼šé¢å‘æ¥å£ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯é¢å‘å®ç°ç¼–ç¨‹ã€‚

```mermaid
graph TB
    subgraph "âŒ è¿å DIP"
        A1[é«˜å±‚æ¨¡å—<br/>OrderService] -->|ç›´æ¥ä¾èµ–| B1[ä½å±‚æ¨¡å—<br/>MySQLOrderDao]
    end
    
    subgraph "âœ… éµå¾ª DIP"
        A2[é«˜å±‚æ¨¡å—<br/>OrderService] -->|ä¾èµ–æŠ½è±¡| C[æ¥å£<br/>OrderDao]
        B2[ä½å±‚æ¨¡å—<br/>MySQLOrderDao] -->|å®ç°| C
        B3[ä½å±‚æ¨¡å—<br/>MongoOrderDao] -->|å®ç°| C
    end
```

**åé¢ç¤ºä¾‹**ï¼šé«˜å±‚ç›´æ¥ä¾èµ–ä½å±‚å®ç°

```java
// âŒ è¿åä¾èµ–å€’ç½®ï¼šOrderService ç›´æ¥ä¾èµ– MySQLOrderDao
public class MySQLOrderDao {
    public void save(Order order) {
        // MySQL ä¿å­˜é€»è¾‘
    }
}

public class OrderService {
    private MySQLOrderDao orderDao = new MySQLOrderDao(); // ç›´æ¥ä¾èµ–å…·ä½“å®ç°
    
    public void createOrder(Order order) {
        orderDao.save(order);
    }
}
// å¦‚æœè¦æ¢æˆ MongoDBï¼Œå¿…é¡»ä¿®æ”¹ OrderService çš„ä»£ç 
```

**æ­£é¢ç¤ºä¾‹**ï¼šé€šè¿‡æ¥å£è§£è€¦

```java
// âœ… éµå¾ªä¾èµ–å€’ç½®
public interface OrderDao {
    void save(Order order);
}

public class MySQLOrderDao implements OrderDao {
    @Override
    public void save(Order order) { /* MySQL ä¿å­˜ */ }
}

public class MongoOrderDao implements OrderDao {
    @Override
    public void save(Order order) { /* MongoDB ä¿å­˜ */ }
}

public class OrderService {
    private OrderDao orderDao; // ä¾èµ–æŠ½è±¡
    
    // é€šè¿‡æ„é€ å™¨æ³¨å…¥ï¼ˆSpring DI çš„æ ¸å¿ƒæ€æƒ³ï¼‰
    public OrderService(OrderDao orderDao) {
        this.orderDao = orderDao;
    }
    
    public void createOrder(Order order) {
        orderDao.save(order);
    }
}
```

**å®é™…åº”ç”¨**ï¼š
- **Spring çš„ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰** å°±æ˜¯ DIP çš„æœ€ä½³å®è·µ
- JDBC çš„ `Connection`ã€`Statement` æ¥å£å±è”½äº†å…·ä½“æ•°æ®åº“å®ç°

---

### 1.3.5 æ¥å£éš”ç¦»åŸåˆ™ï¼ˆISP - Interface Segregation Principleï¼‰

> **å®šä¹‰**ï¼šå®¢æˆ·ç«¯ä¸åº”è¯¥ä¾èµ–å®ƒä¸éœ€è¦çš„æ¥å£ã€‚ä¸€ä¸ªç±»å¯¹å¦ä¸€ä¸ªç±»çš„ä¾èµ–åº”è¯¥å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Šã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼šå°†è‡ƒè‚¿çš„æ¥å£æ‹†åˆ†æˆæ›´å°ã€æ›´å…·ä½“çš„æ¥å£ï¼Œè®©å®ç°ç±»åªéœ€è¦å…³æ³¨è‡ªå·±éœ€è¦çš„æ–¹æ³•ã€‚

**åé¢ç¤ºä¾‹**ï¼šæ¥å£è¿‡äºè‡ƒè‚¿

```java
// âŒ è¿åæ¥å£éš”ç¦»ï¼šä¸€ä¸ªå·¨å¤§çš„"ä¸‡èƒ½"æ¥å£
public interface Animal {
    void eat();
    void sleep();
    void fly();    // ä¸æ˜¯æ‰€æœ‰åŠ¨ç‰©éƒ½ä¼šé£
    void swim();   // ä¸æ˜¯æ‰€æœ‰åŠ¨ç‰©éƒ½ä¼šæ¸¸æ³³
    void climb();  // ä¸æ˜¯æ‰€æœ‰åŠ¨ç‰©éƒ½ä¼šçˆ¬æ ‘
}

// Dog ä¸ä¼šé£ï¼Œä½†è¢«è¿«å®ç° fly()
public class Dog implements Animal {
    @Override public void eat() { /* ... */ }
    @Override public void sleep() { /* ... */ }
    @Override public void fly() { /* ç‹—ä¸ä¼šé£ï¼ç©ºå®ç°æˆ–æŠ›å¼‚å¸¸ */ }
    @Override public void swim() { /* ... */ }
    @Override public void climb() { /* ç‹—ä¸ä¼šçˆ¬æ ‘ï¼ */ }
}
```

**æ­£é¢ç¤ºä¾‹**ï¼šæ¥å£æ‹†åˆ†

```java
// âœ… éµå¾ªæ¥å£éš”ç¦»ï¼šæŒ‰èƒ½åŠ›æ‹†åˆ†æ¥å£
public interface Eatable {
    void eat();
}

public interface Sleepable {
    void sleep();
}

public interface Flyable {
    void fly();
}

public interface Swimmable {
    void swim();
}

// Dog åªå®ç°å®ƒéœ€è¦çš„æ¥å£
public class Dog implements Eatable, Sleepable, Swimmable {
    @Override public void eat() { System.out.println("ç‹—åƒéª¨å¤´"); }
    @Override public void sleep() { System.out.println("ç‹—ç¡è§‰"); }
    @Override public void swim() { System.out.println("ç‹—æ¸¸æ³³"); }
}

// Bird åªå®ç°å®ƒéœ€è¦çš„æ¥å£
public class Bird implements Eatable, Sleepable, Flyable {
    @Override public void eat() { System.out.println("é¸Ÿåƒè™«"); }
    @Override public void sleep() { System.out.println("é¸Ÿç¡è§‰"); }
    @Override public void fly() { System.out.println("é¸Ÿé£ç¿”"); }
}
```

**å®é™…åº”ç”¨**ï¼š
- Java ä¸­çš„ `Serializable`ã€`Cloneable`ã€`Comparable` éƒ½æ˜¯å°ç²’åº¦çš„æ¥å£
- Spring ä¸­çš„ `InitializingBean`ï¼ˆafterPropertiesSetï¼‰å’Œ `DisposableBean`ï¼ˆdestroyï¼‰æ˜¯åˆ†å¼€çš„æ¥å£

---

### 1.3.6 è¿ªç±³ç‰¹æ³•åˆ™ï¼ˆLoD - Law of Demeterï¼‰

> **å®šä¹‰**ï¼šä¸€ä¸ªå¯¹è±¡åº”è¯¥å¯¹å…¶ä»–å¯¹è±¡æœ‰æœ€å°‘çš„äº†è§£ï¼ˆä¹Ÿå«**æœ€å°‘çŸ¥è¯†åŸåˆ™**ï¼‰ã€‚åªä¸ç›´æ¥æœ‹å‹é€šä¿¡ï¼Œä¸ä¸"é™Œç”Ÿäºº"è¯´è¯ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼šé™ä½ç±»ä¹‹é—´çš„è€¦åˆã€‚å¦‚æœä¸¤ä¸ªç±»ä¹‹é—´ä¸å¿…ç›´æ¥é€šä¿¡ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªç±»å°±ä¸åº”å½“å‘ç”Ÿç›´æ¥çš„ç›¸äº’ä½œç”¨ã€‚

**åé¢ç¤ºä¾‹**ï¼šé“¾å¼è°ƒç”¨æš´éœ²å†…éƒ¨ç»“æ„

```java
// âŒ è¿åè¿ªç±³ç‰¹æ³•åˆ™ï¼šæš´éœ²äº†å¤ªå¤šå†…éƒ¨ç»†èŠ‚
public class Customer {
    private Wallet wallet;
    public Wallet getWallet() { return wallet; }
}

public class Wallet {
    private double money;
    public double getMoney() { return money; }
    public void setMoney(double money) { this.money = money; }
}

// è´­ç‰©ä»˜æ¬¾
public class ShoppingService {
    public void pay(Customer customer, double amount) {
        Wallet wallet = customer.getWallet(); // ç›´æ¥æ‹¿åˆ°å®¢æˆ·çš„é’±åŒ…
        if (wallet.getMoney() >= amount) {
            wallet.setMoney(wallet.getMoney() - amount); // ç›´æ¥æ“ä½œé’±åŒ…
        }
    }
}
// ShoppingService ä¸ä»…è®¤è¯† Customerï¼Œè¿˜è®¤è¯† Wallet â€”â€” çŸ¥é“å¤ªå¤šäº†ï¼
```

**æ­£é¢ç¤ºä¾‹**ï¼šé€šè¿‡ä¸­é—´æ–¹æ³•éšè—ç»†èŠ‚

```java
// âœ… éµå¾ªè¿ªç±³ç‰¹æ³•åˆ™ï¼šShoppingService åªä¸ Customer æ‰“äº¤é“
public class Customer {
    private Wallet wallet;
    
    // Customer è‡ªå·±è´Ÿè´£ä»˜æ¬¾é€»è¾‘
    public boolean pay(double amount) {
        if (wallet.getMoney() >= amount) {
            wallet.setMoney(wallet.getMoney() - amount);
            return true;
        }
        return false;
    }
}

public class ShoppingService {
    public void pay(Customer customer, double amount) {
        boolean success = customer.pay(amount); // åªä¸ç›´æ¥æœ‹å‹é€šä¿¡
        if (!success) {
            System.out.println("ä½™é¢ä¸è¶³");
        }
    }
}
```

**å®é™…åº”ç”¨**ï¼š
- å¤–è§‚æ¨¡å¼ï¼ˆFacadeï¼‰å°±æ˜¯è¿ªç±³ç‰¹æ³•åˆ™çš„å…¸å‹åº”ç”¨
- Spring ä¸­ `JdbcTemplate` å°è£…äº† Connectionã€Statement ç­‰åº•å±‚ç»†èŠ‚

---

### 1.3.7 åˆæˆå¤ç”¨åŸåˆ™ï¼ˆCRP - Composite Reuse Principleï¼‰

> **å®šä¹‰**ï¼šå°½é‡ä½¿ç”¨**ç»„åˆ/èšåˆ**çš„æ–¹å¼æ¥å®ç°ä»£ç å¤ç”¨ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç»§æ‰¿ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼šç»§æ‰¿æ˜¯ä¸€ç§å¼ºè€¦åˆå…³ç³»ï¼ˆç™½ç®±å¤ç”¨ï¼‰ï¼Œç»„åˆæ˜¯ä¸€ç§å¼±è€¦åˆå…³ç³»ï¼ˆé»‘ç®±å¤ç”¨ï¼‰ã€‚ä¼˜å…ˆä½¿ç”¨ç»„åˆå¯ä»¥ä½¿ç³»ç»Ÿæ›´åŠ çµæ´»ã€‚

```mermaid
graph LR
    subgraph "âŒ ç»§æ‰¿å¤ç”¨ï¼ˆå¼ºè€¦åˆï¼‰"
        A[MySQLUserDao] -->|ç»§æ‰¿| B[BaseDao]
    end
    
    subgraph "âœ… ç»„åˆå¤ç”¨ï¼ˆå¼±è€¦åˆï¼‰"
        C[UserDao] -->|ç»„åˆ| D[DBConnection æ¥å£]
        E[MySQLConnection] -->|å®ç°| D
        F[OracleConnection] -->|å®ç°| D
    end
```

**åé¢ç¤ºä¾‹**ï¼šé€šè¿‡ç»§æ‰¿å¤ç”¨æ•°æ®åº“è¿æ¥

```java
// âŒ è¿ååˆæˆå¤ç”¨åŸåˆ™ï¼šé€šè¿‡ç»§æ‰¿è·å–æ•°æ®åº“è¿æ¥
public class BaseDao {
    public Connection getConnection() {
        // è·å– MySQL è¿æ¥
        return DriverManager.getConnection("jdbc:mysql://...");
    }
}

// å¦‚æœè¦æ¢ Oracleï¼ŒUserDao å¿…é¡»æ”¹ç»§æ‰¿å…³ç³»
public class UserDao extends BaseDao {
    public void saveUser(User user) {
        Connection conn = getConnection();
        // ...
    }
}
```

**æ­£é¢ç¤ºä¾‹**ï¼šé€šè¿‡ç»„åˆå¤ç”¨

```java
// âœ… éµå¾ªåˆæˆå¤ç”¨åŸåˆ™ï¼šé€šè¿‡ç»„åˆè·å–æ•°æ®åº“è¿æ¥
public interface DBConnection {
    Connection getConnection();
}

public class MySQLConnection implements DBConnection {
    @Override
    public Connection getConnection() {
        return DriverManager.getConnection("jdbc:mysql://...");
    }
}

public class OracleConnection implements DBConnection {
    @Override
    public Connection getConnection() {
        return DriverManager.getConnection("jdbc:oracle://...");
    }
}

public class UserDao {
    private DBConnection dbConnection; // ç»„åˆï¼Œè€Œéç»§æ‰¿
    
    public UserDao(DBConnection dbConnection) {
        this.dbConnection = dbConnection;
    }
    
    public void saveUser(User user) {
        Connection conn = dbConnection.getConnection();
        // ...
    }
}
```

**å®é™…åº”ç”¨**ï¼š
- Spring ä¸­å¹¿æ³›ä½¿ç”¨ç»„åˆè€Œéç»§æ‰¿
- Java ä¸­ `HashSet` å†…éƒ¨ç»„åˆäº† `HashMap`ï¼Œè€Œä¸æ˜¯ç»§æ‰¿å®ƒ

---

### ä¸ƒå¤§è®¾è®¡åŸåˆ™æ€»ç»“è¡¨

| åŸåˆ™ | ä¸€å¥è¯æ€»ç»“ | æ ¸å¿ƒå…³é”®è¯ |
|------|-----------|-----------|
| **å•ä¸€èŒè´£ SRP** | ä¸€ä¸ªç±»åªåšä¸€ä»¶äº‹ | èŒè´£åˆ†ç¦» |
| **å¼€é—­åŸåˆ™ OCP** | å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ | æŠ½è±¡ + å¤šæ€ |
| **é‡Œæ°æ›¿æ¢ LSP** | å­ç±»èƒ½æ›¿ä»£çˆ¶ç±» | æ­£ç¡®ç»§æ‰¿ |
| **ä¾èµ–å€’ç½® DIP** | ä¾èµ–æŠ½è±¡ï¼Œä¸ä¾èµ–å…·ä½“ | é¢å‘æ¥å£ |
| **æ¥å£éš”ç¦» ISP** | æ¥å£è¦å°è€Œç²¾ | æ¥å£æ‹†åˆ† |
| **è¿ªç±³ç‰¹æ³•åˆ™ LoD** | åªä¸ç›´æ¥æœ‹å‹é€šä¿¡ | æœ€å°‘çŸ¥è¯† |
| **åˆæˆå¤ç”¨ CRP** | ä¼˜å…ˆç”¨ç»„åˆï¼Œå°‘ç”¨ç»§æ‰¿ | ç»„åˆ > ç»§æ‰¿ |

> **è®°å¿†å£è¯€**ï¼š**å¼€ï¼ˆOCPï¼‰å£ï¼ˆISPï¼‰åˆï¼ˆCRPï¼‰é‡Œï¼ˆLSPï¼‰å•ï¼ˆSRPï¼‰çš„ï¼ˆDIPï¼‰è¿·ï¼ˆLoDï¼‰** â€”â€” "å¼€å£åˆç†å•çš„è¿·"

---

# äºŒã€å•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰

## 2.1 ä»€ä¹ˆæ˜¯å•ä¾‹æ¨¡å¼

> **å®šä¹‰**ï¼šç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹ã€‚

å•ä¾‹æ¨¡å¼æ˜¯æœ€ç®€å•ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ã€‚å®ƒçš„æ ¸å¿ƒè¦ç‚¹ï¼š
1. **ç§æœ‰æ„é€ å™¨**ï¼šé˜²æ­¢å¤–éƒ¨é€šè¿‡ `new` åˆ›å»ºå®ä¾‹
2. **é™æ€ç§æœ‰å®ä¾‹**ï¼šç±»å†…éƒ¨æŒæœ‰å”¯ä¸€å®ä¾‹
3. **é™æ€å…¬æœ‰æ–¹æ³•**ï¼šæä¾›å…¨å±€è®¿é—®ç‚¹

### UML ç±»å›¾

```mermaid
classDiagram
    class Singleton {
        -static instance: Singleton
        -Singleton()
        +static getInstance(): Singleton
    }
    note for Singleton "1. æ„é€ å™¨ç§æœ‰\n2. é™æ€æŒæœ‰å”¯ä¸€å®ä¾‹\n3. æä¾›å…¨å±€è®¿é—®æ–¹æ³•"
```

### é€‚ç”¨åœºæ™¯

- é…ç½®ç®¡ç†ï¼ˆæ•´ä¸ªåº”ç”¨åªéœ€è¦ä¸€ä»½é…ç½®ï¼‰
- è¿æ¥æ± ï¼ˆæ•°æ®åº“è¿æ¥æ± ã€çº¿ç¨‹æ± ï¼‰
- æ—¥å¿—è®°å½•å™¨
- Spring ä¸­çš„ Beanï¼ˆé»˜è®¤å•ä¾‹ï¼‰
- Runtime ç±»ï¼ˆ`Runtime.getRuntime()`ï¼‰

---

## 2.2 é¥¿æ±‰å¼ï¼ˆEager Initializationï¼‰

### 2.2.1 é™æ€å¸¸é‡æ–¹å¼

```java
/**
 * é¥¿æ±‰å¼ - é™æ€å¸¸é‡
 * ä¼˜ç‚¹ï¼šå†™æ³•ç®€å•ï¼Œç±»åŠ è½½æ—¶å®Œæˆå®ä¾‹åŒ–ï¼Œå¤©ç”Ÿçº¿ç¨‹å®‰å…¨
 * ç¼ºç‚¹ï¼šæ— è®ºæ˜¯å¦ä½¿ç”¨éƒ½ä¼šåˆ›å»ºå®ä¾‹ï¼Œå¯èƒ½é€ æˆå†…å­˜æµªè´¹
 */
public class Singleton1 {
    // 1. ç§æœ‰æ„é€ å™¨
    private Singleton1() {}
    
    // 2. ç±»åŠ è½½æ—¶å°±åˆ›å»ºå®ä¾‹ï¼ˆé™æ€å¸¸é‡ï¼‰
    private static final Singleton1 INSTANCE = new Singleton1();
    
    // 3. æä¾›å…¨å±€è®¿é—®ç‚¹
    public static Singleton1 getInstance() {
        return INSTANCE;
    }
}
```

**åŸç†åˆ†æ**ï¼š
- åˆ©ç”¨ JVM çš„**ç±»åŠ è½½æœºåˆ¶**ä¿è¯çº¿ç¨‹å®‰å…¨
- `static final` å˜é‡åœ¨ç±»åŠ è½½çš„**åˆå§‹åŒ–é˜¶æ®µ**ç”± `<clinit>()` æ–¹æ³•å®Œæˆèµ‹å€¼
- JVM ä¿è¯ `<clinit>()` æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆåªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼‰

### 2.2.2 é™æ€ä»£ç å—æ–¹å¼

```java
/**
 * é¥¿æ±‰å¼ - é™æ€ä»£ç å—
 * ä¸é™æ€å¸¸é‡æ–¹å¼æœ¬è´¨ç›¸åŒï¼Œä½†å¯ä»¥åœ¨åˆå§‹åŒ–æ—¶åšæ›´å¤šæ“ä½œï¼ˆå¦‚è¯»å–é…ç½®ï¼‰
 */
public class Singleton2 {
    private Singleton2() {}
    
    private static final Singleton2 INSTANCE;
    
    static {
        // å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œå¦‚è¯»å–é…ç½®æ–‡ä»¶
        INSTANCE = new Singleton2();
    }
    
    public static Singleton2 getInstance() {
        return INSTANCE;
    }
}
```

> **é¥¿æ±‰å¼æ€»ç»“**ï¼šçº¿ç¨‹å®‰å…¨ï¼Œä½†ä¸æ”¯æŒæ‡’åŠ è½½ã€‚é€‚ç”¨äº**ç¡®å®šä¼šè¢«ä½¿ç”¨**æˆ–**å®ä¾‹å ç”¨èµ„æºå°‘**çš„åœºæ™¯ã€‚

---

## 2.3 æ‡’æ±‰å¼ï¼ˆLazy Initializationï¼‰

### 2.3.1 çº¿ç¨‹ä¸å®‰å…¨ç‰ˆæœ¬

```java
/**
 * æ‡’æ±‰å¼ - çº¿ç¨‹ä¸å®‰å…¨
 * âŒ å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½åˆ›å»ºå¤šä¸ªå®ä¾‹ï¼
 */
public class Singleton3 {
    private Singleton3() {}
    
    private static Singleton3 instance;
    
    public static Singleton3 getInstance() {
        if (instance == null) {           // çº¿ç¨‹Aåˆ¤æ–­ä¸ºnull
            instance = new Singleton3();  // çº¿ç¨‹Bä¹Ÿåˆ¤æ–­ä¸ºnullï¼Œåˆ›å»ºäº†ç¬¬äºŒä¸ªå®ä¾‹ï¼
        }
        return instance;
    }
}
```

**çº¿ç¨‹ä¸å®‰å…¨çš„æ—¶åºåˆ†æ**ï¼š

```
æ—¶é—´çº¿  çº¿ç¨‹A                    çº¿ç¨‹B
  t1    if (instance == null)   
  t2    â†’ true                  if (instance == null)
  t3    new Singleton3()        â†’ true
  t4    èµ‹å€¼ç»™ instance          new Singleton3()  â† åˆ›å»ºäº†ç¬¬äºŒä¸ªå®ä¾‹ï¼
  t5                            èµ‹å€¼ç»™ instance
```

> âš ï¸ **ç»“è®º**ï¼šçº¿ç¨‹ä¸å®‰å…¨çš„æ‡’æ±‰å¼**ç»å¯¹ä¸èƒ½åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨**ã€‚

### 2.3.2 synchronized åŒæ­¥æ–¹æ³•

```java
/**
 * æ‡’æ±‰å¼ - synchronized åŒæ­¥æ–¹æ³•
 * ä¼˜ç‚¹ï¼šçº¿ç¨‹å®‰å…¨
 * ç¼ºç‚¹ï¼šæ¯æ¬¡è°ƒç”¨éƒ½è¦è·å–é”ï¼Œæ€§èƒ½æå·®
 */
public class Singleton4 {
    private Singleton4() {}
    
    private static Singleton4 instance;
    
    // æ•´ä¸ªæ–¹æ³•åŠ é”
    public static synchronized Singleton4 getInstance() {
        if (instance == null) {
            instance = new Singleton4();
        }
        return instance;
    }
}
```

**é—®é¢˜**ï¼šå®ä¾‹åˆ›å»ºä¹‹åï¼Œåç»­æ¯æ¬¡è°ƒç”¨ `getInstance()` éƒ½è¦ç«äº‰é”ï¼Œè€Œæ­¤æ—¶ `instance` å·²ç»ä¸ä¸º null äº†ï¼ŒåŠ é”æ¯«æ— æ„ä¹‰ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦ DCLã€‚

### 2.3.3 DCL åŒé‡æ£€æŸ¥é”ï¼ˆDouble-Checked Lockingï¼‰â­â­â­

```java
/**
 * æ‡’æ±‰å¼ - DCL åŒé‡æ£€æŸ¥é”
 * â­ æ¨èå†™æ³•ä¹‹ä¸€
 * ä¼˜ç‚¹ï¼šçº¿ç¨‹å®‰å…¨ + æ‡’åŠ è½½ + æ€§èƒ½å¥½ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡åŠ é”ï¼‰
 */
public class Singleton5 {
    private Singleton5() {}
    
    // ğŸ”‘ volatile æ˜¯å…³é”®ï¼é˜²æ­¢æŒ‡ä»¤é‡æ’åº
    private static volatile Singleton5 instance;
    
    public static Singleton5 getInstance() {
        if (instance == null) {              // ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼ˆæ— é”ï¼‰
            synchronized (Singleton5.class) { // åŠ é”
                if (instance == null) {       // ç¬¬äºŒæ¬¡æ£€æŸ¥ï¼ˆæœ‰é”ï¼‰
                    instance = new Singleton5();
                }
            }
        }
        return instance;
    }
}
```

**ä¸ºä»€ä¹ˆéœ€è¦åŒé‡æ£€æŸ¥ï¼Ÿ**

```
æ—¶é—´çº¿  çº¿ç¨‹A                         çº¿ç¨‹B
  t1    ç¬¬ä¸€æ¬¡æ£€æŸ¥ instance == null
  t2    â†’ trueï¼Œè¿›å…¥ synchronized    
  t3    è·å–é”                         ç¬¬ä¸€æ¬¡æ£€æŸ¥ instance == null
  t4    ç¬¬äºŒæ¬¡æ£€æŸ¥ instance == null     â†’ trueï¼Œç­‰å¾…è·å–é”
  t5    â†’ trueï¼Œåˆ›å»ºå®ä¾‹
  t6    é‡Šæ”¾é”                         
  t7                                   è·å–é”
  t8                                   ç¬¬äºŒæ¬¡æ£€æŸ¥ instance == null
  t9                                   â†’ falseï¼ä¸å†åˆ›å»ºå®ä¾‹ âœ…
  t10                                  é‡Šæ”¾é”
```

- **ç¬¬ä¸€æ¬¡æ£€æŸ¥**ï¼šé¿å…ä¸å¿…è¦çš„åŠ é”ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- **ç¬¬äºŒæ¬¡æ£€æŸ¥**ï¼šé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶é€šè¿‡ç¬¬ä¸€æ¬¡æ£€æŸ¥åé‡å¤åˆ›å»ºå®ä¾‹

---

## 2.4 DCL ä¸ºä»€ä¹ˆéœ€è¦ volatile â­â­â­â­â­

è¿™æ˜¯é¢è¯•ä¸­**æé«˜é¢‘**çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯ç†è§£ Java å†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰çš„å…³é”®ã€‚

### 2.4.1 `new` æ“ä½œçš„ä¸‰æ­¥æ‹†è§£

`instance = new Singleton5();` è¿™è¡Œä»£ç åœ¨ JVM å±‚é¢ä¸æ˜¯åŸå­æ“ä½œï¼Œå®ƒåˆ†ä¸ºä¸‰æ­¥ï¼š

```
â‘  memory = allocate();     // åˆ†é…å†…å­˜ç©ºé—´
â‘¡ ctorInstance(memory);    // åˆå§‹åŒ–å¯¹è±¡ï¼ˆè°ƒç”¨æ„é€ æ–¹æ³•ï¼‰
â‘¢ instance = memory;       // å°† instance æŒ‡å‘åˆ†é…çš„å†…å­˜åœ°å€
```

### 2.4.2 æŒ‡ä»¤é‡æ’åºé—®é¢˜

JVM çš„**å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰** å’Œ **CPU** ä¸ºäº†æé«˜æ€§èƒ½ï¼Œå¯èƒ½ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºã€‚æ­¥éª¤ â‘¡ å’Œ â‘¢ **æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»**ï¼Œå› æ­¤å¯èƒ½è¢«é‡æ’åºä¸ºï¼š

```
â‘  memory = allocate();     // åˆ†é…å†…å­˜ç©ºé—´
â‘¢ instance = memory;       // instance å·²ç»æŒ‡å‘å†…å­˜ï¼ˆä½†å¯¹è±¡è¿˜æœªåˆå§‹åŒ–ï¼ï¼‰
â‘¡ ctorInstance(memory);    // åˆå§‹åŒ–å¯¹è±¡
```

### 2.4.3 æ²¡æœ‰ volatile ä¼šæ€æ ·ï¼Ÿ

```
æ—¶é—´çº¿  çº¿ç¨‹A                              çº¿ç¨‹B
  t1    â‘  allocate memory
  t2    â‘¢ instance = memoryï¼ˆå°šæœªåˆå§‹åŒ–ï¼ï¼‰
  t3                                       ç¬¬ä¸€æ¬¡æ£€æŸ¥ instance == null
  t4                                       â†’ falseï¼ˆinstance å·²ç»æœ‰å€¼äº†ï¼‰
  t5                                       return instance  â† ğŸš¨ è¿”å›æœªåˆå§‹åŒ–çš„å¯¹è±¡ï¼
  t6    â‘¡ ctorInstanceï¼ˆæ‰å¼€å§‹åˆå§‹åŒ–ï¼‰
```

**ä¸¥é‡åæœ**ï¼šçº¿ç¨‹Bæ‹¿åˆ°äº†ä¸€ä¸ª**å°šæœªå®Œæˆåˆå§‹åŒ–çš„å¯¹è±¡**ï¼ä½¿ç”¨è¿™ä¸ªå¯¹è±¡å¯èƒ½å¯¼è‡´ NPE æˆ–ä¸å¯é¢„æœŸçš„è¡Œä¸ºã€‚

### 2.4.4 volatile å¦‚ä½•è§£å†³ï¼Ÿ

```mermaid
graph TB
    A[volatile çš„ä¸¤ä¸ªè¯­ä¹‰] --> B[å¯è§æ€§<br/>ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹å<br/>å…¶ä»–çº¿ç¨‹ç«‹å³å¯è§]
    A --> C[ç¦æ­¢é‡æ’åº<br/>é€šè¿‡å†…å­˜å±éšœ<br/>ä¿è¯ â‘ â‘¡â‘¢ é¡ºåºæ‰§è¡Œ]
    
    C --> D[StoreStore å±éšœ<br/>ç¡®ä¿å†™æ“ä½œä¹‹é—´ä¸é‡æ’]
    C --> E[StoreLoad å±éšœ<br/>ç¡®ä¿å†™æ“ä½œå¯¹åç»­è¯»å¯è§]
```

`volatile` é€šè¿‡åœ¨å…³é”®ä½ç½®æ’å…¥**å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰** æ¥ç¦æ­¢é‡æ’åºï¼š

```
// åŠ äº† volatile åçš„æ‰§è¡Œé¡ºåºï¼ˆç»å¯¹ä¸ä¼šé‡æ’ï¼‰ï¼š
â‘  memory = allocate();       // åˆ†é…å†…å­˜
â‘¡ ctorInstance(memory);      // åˆå§‹åŒ–å¯¹è±¡
--- StoreStore Barrier ---   // å†…å­˜å±éšœï¼Œç¡®ä¿ â‘¡ åœ¨ â‘¢ ä¹‹å‰å®Œæˆ
â‘¢ instance = memory;         // èµ‹å€¼
--- StoreLoad Barrier ---    // å†…å­˜å±éšœï¼Œç¡®ä¿ â‘¢ å¯¹å…¶ä»–çº¿ç¨‹å¯è§
```

> **ç»“è®º**ï¼šDCL ä¸­çš„ `volatile` ä¸ä»…ä¿è¯å¯è§æ€§ï¼Œæ›´é‡è¦çš„æ˜¯**ç¦æ­¢æŒ‡ä»¤é‡æ’åº**ï¼Œç¡®ä¿å…¶ä»–çº¿ç¨‹çœ‹åˆ°çš„ `instance` è¦ä¹ˆæ˜¯ `null`ï¼Œè¦ä¹ˆæ˜¯**å®Œå…¨åˆå§‹åŒ–å¥½çš„å¯¹è±¡**ã€‚

---

## 2.5 é™æ€å†…éƒ¨ç±»æ–¹å¼ â­â­â­

```java
/**
 * é™æ€å†…éƒ¨ç±»æ–¹å¼
 * â­ æ¨èå†™æ³•ä¹‹ä¸€
 * å…¼å…·æ‡’åŠ è½½å’Œçº¿ç¨‹å®‰å…¨ï¼Œä¸”ä»£ç ç®€æ´
 */
public class Singleton6 {
    private Singleton6() {}
    
    // é™æ€å†…éƒ¨ç±»ä¸ä¼šéšå¤–éƒ¨ç±»åŠ è½½è€ŒåŠ è½½
    private static class SingletonHolder {
        private static final Singleton6 INSTANCE = new Singleton6();
    }
    
    public static Singleton6 getInstance() {
        return SingletonHolder.INSTANCE; // è§¦å‘å†…éƒ¨ç±»åŠ è½½
    }
}
```

**åŸç†åˆ†æ**ï¼š

1. **æ‡’åŠ è½½**ï¼š`SingletonHolder` æ˜¯é™æ€å†…éƒ¨ç±»ï¼Œä¸ä¼šéšç€ `Singleton6` çš„åŠ è½½è€ŒåŠ è½½ã€‚åªæœ‰å½“ç¬¬ä¸€æ¬¡è°ƒç”¨ `getInstance()` æ—¶ï¼ŒJVM æ‰ä¼šåŠ è½½ `SingletonHolder`
2. **çº¿ç¨‹å®‰å…¨**ï¼šJVM ä¿è¯ç±»åŠ è½½è¿‡ç¨‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆ`<clinit>()` æ–¹æ³•ç”± JVM åŠ é”ä¿æŠ¤ï¼‰
3. **æ— é”**ï¼šä¸éœ€è¦ `synchronized`ï¼Œæ€§èƒ½å¥½

> **JVM ç±»åŠ è½½æ—¶æœº**ï¼ˆ5ç§ä¸»åŠ¨å¼•ç”¨ï¼‰ï¼š
> - new å®ä¾‹ã€è¯»å†™é™æ€å­—æ®µã€è°ƒç”¨é™æ€æ–¹æ³•
> - åå°„è°ƒç”¨
> - åˆå§‹åŒ–å­ç±»æ—¶å…ˆåˆå§‹åŒ–çˆ¶ç±»
> - ä¸»ç±»ï¼ˆåŒ…å« main æ–¹æ³•çš„ç±»ï¼‰
> - JDK 7+ çš„åŠ¨æ€è¯­è¨€æ”¯æŒ

---

## 2.6 æšä¸¾æ–¹å¼ â­â­â­â­â­

```java
/**
 * æšä¸¾æ–¹å¼
 * â­â­â­ æœ€æ¨èçš„å•ä¾‹å®ç°æ–¹å¼
 * Effective Java ä½œè€… Joshua Bloch æ¨è
 * ä¼˜ç‚¹ï¼šå†™æ³•æœ€ç®€æ´ã€å¤©ç„¶çº¿ç¨‹å®‰å…¨ã€é˜²åå°„æ”»å‡»ã€é˜²åºåˆ—åŒ–ç ´å
 */
public enum Singleton7 {
    INSTANCE;
    
    // å¯ä»¥æ·»åŠ è‡ªå·±çš„æ–¹æ³•
    private int count = 0;
    
    public void doSomething() {
        System.out.println("æšä¸¾å•ä¾‹æ‰§è¡Œä¸šåŠ¡é€»è¾‘, count=" + (++count));
    }
}

// ä½¿ç”¨æ–¹å¼
// Singleton7.INSTANCE.doSomething();
```

**ä¸ºä»€ä¹ˆæšä¸¾æ˜¯æœ€æ¨èçš„ï¼Ÿ**

1. **å†™æ³•æœ€ç®€æ´**ï¼šåªéœ€è¦ä¸€ä¸ª `enum` å£°æ˜
2. **å¤©ç„¶çº¿ç¨‹å®‰å…¨**ï¼šæšä¸¾å®ä¾‹åœ¨ç±»åŠ è½½æ—¶ç”± JVM åˆ›å»ºï¼Œä¿è¯çº¿ç¨‹å®‰å…¨
3. **é˜²æ­¢åå°„æ”»å‡»**ï¼š`Constructor.newInstance()` åœ¨é‡åˆ°æšä¸¾ç±»å‹æ—¶ä¼šç›´æ¥æŠ›å‡º `IllegalArgumentException`
4. **é˜²æ­¢åºåˆ—åŒ–ç ´å**ï¼šJava åºåˆ—åŒ–æœºåˆ¶å¯¹æšä¸¾æœ‰ç‰¹æ®Šå¤„ç†ï¼Œååºåˆ—åŒ–æ—¶ä¸ä¼šåˆ›å»ºæ–°å®ä¾‹

**åç¼–è¯‘æšä¸¾**å¯ä»¥çœ‹åˆ°ï¼Œæšä¸¾æœ¬è´¨ä¸Šæ˜¯ï¼š

```java
public final class Singleton7 extends Enum<Singleton7> {
    public static final Singleton7 INSTANCE;
    
    static {
        INSTANCE = new Singleton7("INSTANCE", 0);
    }
    
    private Singleton7(String name, int ordinal) {
        super(name, ordinal);
    }
}
```

---

## 2.7 åå°„ç ´åå•ä¾‹ + é˜²å¾¡æ–¹æ¡ˆ

### 2.7.1 åå°„å¦‚ä½•ç ´åå•ä¾‹

```java
// åå°„ç ´åå•ä¾‹çš„æ¼”ç¤º
public class ReflectionAttack {
    public static void main(String[] args) throws Exception {
        // æ­£å¸¸è·å–å•ä¾‹
        Singleton6 s1 = Singleton6.getInstance();
        
        // é€šè¿‡åå°„è·å–ç§æœ‰æ„é€ å™¨
        Constructor<Singleton6> constructor = Singleton6.class.getDeclaredConstructor();
        constructor.setAccessible(true); // æš´åŠ›ç ´è§£ç§æœ‰è®¿é—®
        
        // åå°„åˆ›å»ºæ–°å®ä¾‹
        Singleton6 s2 = constructor.newInstance();
        
        System.out.println(s1 == s2); // falseï¼å•ä¾‹è¢«ç ´åäº†ï¼
    }
}
```

### 2.7.2 é˜²å¾¡æ–¹æ¡ˆï¼šåœ¨æ„é€ å™¨ä¸­æ£€æŸ¥

```java
public class Singleton6 {
    private static boolean created = false;
    
    private Singleton6() {
        // é˜²å¾¡åå°„æ”»å‡»
        synchronized (Singleton6.class) {
            if (created) {
                throw new RuntimeException("ç¦æ­¢åå°„åˆ›å»ºå•ä¾‹å®ä¾‹ï¼");
            }
            created = true;
        }
    }
    
    private static class SingletonHolder {
        private static final Singleton6 INSTANCE = new Singleton6();
    }
    
    public static Singleton6 getInstance() {
        return SingletonHolder.INSTANCE;
    }
}
```

æˆ–è€…ï¼š

```java
private Singleton6() {
    if (SingletonHolder.INSTANCE != null) {
        throw new RuntimeException("ç¦æ­¢åå°„åˆ›å»ºå•ä¾‹å®ä¾‹ï¼");
    }
}
```

> âš ï¸ **æ³¨æ„**ï¼šä¸Šè¿°é˜²å¾¡æ–¹æ¡ˆéƒ½ä¸æ˜¯ä¸‡æ— ä¸€å¤±çš„ï¼ˆåå°„å¯ä»¥ä¿®æ”¹ `created` æ ‡å¿—ä½ï¼‰ï¼Œåªæœ‰**æšä¸¾æ–¹å¼æ‰èƒ½ä» JVM å±‚é¢å½»åº•é˜²æ­¢åå°„æ”»å‡»**ã€‚

---

## 2.8 åºåˆ—åŒ–ç ´åå•ä¾‹ + readResolve() é˜²å¾¡

### 2.8.1 åºåˆ—åŒ–å¦‚ä½•ç ´åå•ä¾‹

```java
public class Singleton6 implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private Singleton6() {}
    
    private static class SingletonHolder {
        private static final Singleton6 INSTANCE = new Singleton6();
    }
    
    public static Singleton6 getInstance() {
        return SingletonHolder.INSTANCE;
    }
}

// åºåˆ—åŒ–ç ´åå•ä¾‹çš„æ¼”ç¤º
public class SerializationAttack {
    public static void main(String[] args) throws Exception {
        Singleton6 s1 = Singleton6.getInstance();
        
        // åºåˆ—åŒ–
        ObjectOutputStream oos = new ObjectOutputStream(
            new FileOutputStream("singleton.bin"));
        oos.writeObject(s1);
        oos.close();
        
        // ååºåˆ—åŒ–
        ObjectInputStream ois = new ObjectInputStream(
            new FileInputStream("singleton.bin"));
        Singleton6 s2 = (Singleton6) ois.readObject();
        ois.close();
        
        System.out.println(s1 == s2); // falseï¼ååºåˆ—åŒ–åˆ›å»ºäº†æ–°å®ä¾‹ï¼
    }
}
```

### 2.8.2 é˜²å¾¡æ–¹æ¡ˆï¼šreadResolve() æ–¹æ³•

```java
public class Singleton6 implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private Singleton6() {}
    
    private static class SingletonHolder {
        private static final Singleton6 INSTANCE = new Singleton6();
    }
    
    public static Singleton6 getInstance() {
        return SingletonHolder.INSTANCE;
    }
    
    /**
     * å…³é”®ï¼ååºåˆ—åŒ–æ—¶ JVM ä¼šè‡ªåŠ¨è°ƒç”¨æ­¤æ–¹æ³•æ›¿æ¢ååºåˆ—åŒ–ç”Ÿæˆçš„æ–°å¯¹è±¡
     * ObjectInputStream.readObject() æºç ä¸­ä¼šæ£€æŸ¥æ˜¯å¦æœ‰ readResolve() æ–¹æ³•
     */
    private Object readResolve() {
        return SingletonHolder.INSTANCE;
    }
}
```

**readResolve() åŸç†**ï¼š

```mermaid
sequenceDiagram
    participant App as åº”ç”¨ç¨‹åº
    participant OIS as ObjectInputStream
    participant Singleton as Singleton6
    
    App->>OIS: readObject()
    OIS->>OIS: ååºåˆ—åŒ–åˆ›å»ºæ–°å¯¹è±¡ newObj
    OIS->>Singleton: æ£€æŸ¥æ˜¯å¦æœ‰ readResolve()
    alt æœ‰ readResolve()
        Singleton-->>OIS: è¿”å› INSTANCE
        OIS->>OIS: ç”¨ INSTANCE æ›¿ä»£ newObj
        OIS-->>App: è¿”å› INSTANCEï¼ˆåŒä¸€å®ä¾‹ï¼‰
    else æ²¡æœ‰ readResolve()
        OIS-->>App: è¿”å› newObjï¼ˆæ–°å®ä¾‹ï¼Œå•ä¾‹è¢«ç ´åï¼ï¼‰
    end
```

---

## 2.9 å„ç§å®ç°æ–¹å¼å¯¹æ¯”è¡¨

| å®ç°æ–¹å¼ | çº¿ç¨‹å®‰å…¨ | æ‡’åŠ è½½ | é˜²åå°„ | é˜²åºåˆ—åŒ– | æ€§èƒ½ | æ¨èåº¦ |
|---------|---------|--------|--------|---------|------|--------|
| é¥¿æ±‰å¼ï¼ˆé™æ€å¸¸é‡ï¼‰ | âœ… | âŒ | âŒ | âŒ | â­â­â­â­â­ | â­â­â­ |
| é¥¿æ±‰å¼ï¼ˆé™æ€ä»£ç å—ï¼‰ | âœ… | âŒ | âŒ | âŒ | â­â­â­â­â­ | â­â­â­ |
| æ‡’æ±‰å¼ï¼ˆçº¿ç¨‹ä¸å®‰å…¨ï¼‰ | âŒ | âœ… | âŒ | âŒ | â­â­â­â­â­ | â›” |
| æ‡’æ±‰å¼ï¼ˆsynchronizedï¼‰ | âœ… | âœ… | âŒ | âŒ | â­ | â­ |
| DCL åŒé‡æ£€æŸ¥é” | âœ… | âœ… | âŒ | âŒ | â­â­â­â­ | â­â­â­â­ |
| é™æ€å†…éƒ¨ç±» | âœ… | âœ… | âŒ | âŒ* | â­â­â­â­â­ | â­â­â­â­ |
| **æšä¸¾** | âœ… | âŒ | âœ… | âœ… | â­â­â­â­â­ | â­â­â­â­â­ |

> âŒ* éœ€æ‰‹åŠ¨æ·»åŠ  readResolve() æ–¹æ³•

**æ¨èé€‰æ‹©**ï¼š
- **ä¸éœ€è¦æ‡’åŠ è½½** â†’ æšä¸¾æ–¹å¼ï¼ˆæœ€å®‰å…¨æœ€ç®€æ´ï¼‰
- **éœ€è¦æ‡’åŠ è½½** â†’ é™æ€å†…éƒ¨ç±» æˆ– DCL
- **éœ€è¦åºåˆ—åŒ–** â†’ æšä¸¾æ–¹å¼

---

## 2.10 Spring ä¸­çš„å•ä¾‹

### Spring å•ä¾‹ vs GOF å•ä¾‹

| ç»´åº¦ | GOF å•ä¾‹ | Spring å•ä¾‹ |
|------|---------|------------|
| **ä½œç”¨èŒƒå›´** | æ•´ä¸ª JVMï¼ˆä¸€ä¸ª ClassLoader ä¸€ä¸ªå®ä¾‹ï¼‰ | ä¸€ä¸ª Spring IoC å®¹å™¨ï¼ˆApplicationContextï¼‰ä¸€ä¸ªå®ä¾‹ |
| **å®ç°æ–¹å¼** | ç§æœ‰æ„é€ å™¨ + é™æ€æ–¹æ³• | é€šè¿‡ Bean å®šä¹‰ + IoC å®¹å™¨ç®¡ç† |
| **åˆ›å»ºæ§åˆ¶** | ç±»è‡ªå·±æ§åˆ¶ | Spring å®¹å™¨æ§åˆ¶ï¼ˆæ§åˆ¶åè½¬ï¼‰ |
| **å¤šä¸ªå®¹å™¨** | ä»ç„¶åªæœ‰ä¸€ä¸ªå®ä¾‹ | æ¯ä¸ªå®¹å™¨å„æœ‰ä¸€ä¸ªå®ä¾‹ |

### Spring å•ä¾‹çš„å®ç°åŸç†

Spring ä½¿ç”¨ **ConcurrentHashMap** ä½œä¸ºå•ä¾‹æ³¨å†Œè¡¨ï¼ˆSingleton Registryï¼‰ï¼š

```java
// Spring æºç ç®€åŒ–ç‰ˆï¼ˆDefaultSingletonBeanRegistryï¼‰
public class DefaultSingletonBeanRegistry {
    // ä¸€çº§ç¼“å­˜ï¼šå­˜æ”¾å®Œå…¨åˆå§‹åŒ–å¥½çš„å•ä¾‹ Bean
    private final Map<String, Object> singletonObjects = new ConcurrentHashMap<>();
    
    public Object getSingleton(String beanName) {
        // å…ˆä»ç¼“å­˜ä¸­è·å–
        Object singletonObject = this.singletonObjects.get(beanName);
        if (singletonObject == null) {
            synchronized (this.singletonObjects) {
                singletonObject = this.singletonObjects.get(beanName);
                if (singletonObject == null) {
                    // åˆ›å»º Bean å®ä¾‹
                    singletonObject = createBean(beanName);
                    // æ”¾å…¥ç¼“å­˜
                    this.singletonObjects.put(beanName, singletonObject);
                }
            }
        }
        return singletonObject;
    }
}
```

> ä½ ä¼šå‘ç°ï¼ŒSpring çš„å•ä¾‹å®ç°æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª**"æ³¨å†Œè¡¨æ¨¡å¼" + DCL åŒé‡æ£€æŸ¥é”**ã€‚

```mermaid
classDiagram
    class DefaultSingletonBeanRegistry {
        -Map~String, Object~ singletonObjects
        +Object getSingleton(String beanName)
        +void registerSingleton(String beanName, Object obj)
    }
    
    class AbstractBeanFactory {
        +Object getBean(String name)
    }
    
    class DefaultListableBeanFactory {
        +Object createBean(String beanName)
    }
    
    AbstractBeanFactory --|> DefaultSingletonBeanRegistry
    DefaultListableBeanFactory --|> AbstractBeanFactory
    
    note for DefaultSingletonBeanRegistry "ä½¿ç”¨ ConcurrentHashMap\nä½œä¸ºå•ä¾‹æ³¨å†Œè¡¨\næœ¬è´¨æ˜¯ DCL + Registry"
```

---

# ä¸‰ã€å·¥å‚æ¨¡å¼ï¼ˆFactoryï¼‰

å·¥å‚æ¨¡å¼æ˜¯æœ€å¸¸ç”¨çš„åˆ›å»ºå‹æ¨¡å¼ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯**å°†å¯¹è±¡çš„åˆ›å»ºä¸ä½¿ç”¨åˆ†ç¦»**ã€‚

## 3.1 ç®€å•å·¥å‚æ¨¡å¼ï¼ˆSimple Factory / Static Factory Methodï¼‰

> **ä¸¥æ ¼æ¥è¯´**ï¼Œç®€å•å·¥å‚ä¸å±äº GOF 23 ç§è®¾è®¡æ¨¡å¼ï¼Œä½†å®ƒæ˜¯å·¥å‚æ–¹æ³•æ¨¡å¼çš„åŸºç¡€ï¼Œå®é™…å¼€å‘ä¸­ä½¿ç”¨éå¸¸å¹¿æ³›ã€‚

### 3.1.1 éœ€æ±‚åœºæ™¯

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª Pizza åº—ï¼Œéœ€è¦æ ¹æ®å®¢æˆ·è®¢å•åˆ›å»ºä¸åŒç±»å‹çš„ Pizzaï¼š

```java
// âŒ ä¸ä½¿ç”¨å·¥å‚æ¨¡å¼ï¼šå®¢æˆ·ç«¯ç›´æ¥ new å¯¹è±¡
public class PizzaStore {
    public Pizza orderPizza(String type) {
        Pizza pizza;
        if ("cheese".equals(type)) {
            pizza = new CheesePizza();
        } else if ("pepperoni".equals(type)) {
            pizza = new PepperoniPizza();
        } else if ("veggie".equals(type)) {
            pizza = new VeggiePizza();
        } else {
            throw new IllegalArgumentException("æœªçŸ¥çš„ Pizza ç±»å‹: " + type);
        }
        
        pizza.prepare();
        pizza.bake();
        pizza.cut();
        pizza.box();
        return pizza;
    }
}
// é—®é¢˜ï¼šæ¯æ–°å¢ä¸€ç§ Pizzaï¼Œéƒ½è¦ä¿®æ”¹ PizzaStore â€”â€” è¿åå¼€é—­åŸåˆ™
```

### 3.1.2 ç®€å•å·¥å‚å®ç°

```java
// äº§å“æ¥å£
public interface Pizza {
    void prepare();
    void bake();
    void cut();
    void box();
}

// å…·ä½“äº§å“
public class CheesePizza implements Pizza {
    @Override public void prepare() { System.out.println("å‡†å¤‡å¥¶é…ª Pizza åŸæ–™"); }
    @Override public void bake() { System.out.println("çƒ˜çƒ¤å¥¶é…ª Pizza"); }
    @Override public void cut() { System.out.println("åˆ‡å‰²å¥¶é…ª Pizza"); }
    @Override public void box() { System.out.println("åŒ…è£…å¥¶é…ª Pizza"); }
}

public class PepperoniPizza implements Pizza {
    @Override public void prepare() { System.out.println("å‡†å¤‡æ„å¤§åˆ©è¾£è‚  Pizza åŸæ–™"); }
    @Override public void bake() { System.out.println("çƒ˜çƒ¤æ„å¤§åˆ©è¾£è‚  Pizza"); }
    @Override public void cut() { System.out.println("åˆ‡å‰²æ„å¤§åˆ©è¾£è‚  Pizza"); }
    @Override public void box() { System.out.println("åŒ…è£…æ„å¤§åˆ©è¾£è‚  Pizza"); }
}

// ç®€å•å·¥å‚
public class SimplePizzaFactory {
    // é™æ€å·¥å‚æ–¹æ³•
    public static Pizza createPizza(String type) {
        switch (type) {
            case "cheese":    return new CheesePizza();
            case "pepperoni": return new PepperoniPizza();
            case "veggie":    return new VeggiePizza();
            default: throw new IllegalArgumentException("æœªçŸ¥çš„ Pizza ç±»å‹: " + type);
        }
    }
}

// ä½¿ç”¨
public class PizzaStore {
    public Pizza orderPizza(String type) {
        Pizza pizza = SimplePizzaFactory.createPizza(type); // åˆ›å»ºä¸ä½¿ç”¨åˆ†ç¦»
        pizza.prepare();
        pizza.bake();
        pizza.cut();
        pizza.box();
        return pizza;
    }
}
```

### 3.1.3 UML ç±»å›¾

```mermaid
classDiagram
    class Pizza {
        <<interface>>
        +prepare()
        +bake()
        +cut()
        +box()
    }
    
    class CheesePizza {
        +prepare()
        +bake()
        +cut()
        +box()
    }
    
    class PepperoniPizza {
        +prepare()
        +bake()
        +cut()
        +box()
    }
    
    class VeggiePizza {
        +prepare()
        +bake()
        +cut()
        +box()
    }
    
    class SimplePizzaFactory {
        +static createPizza(String type) Pizza
    }
    
    class PizzaStore {
        +orderPizza(String type) Pizza
    }
    
    Pizza <|.. CheesePizza
    Pizza <|.. PepperoniPizza
    Pizza <|.. VeggiePizza
    SimplePizzaFactory ..> Pizza : creates
    PizzaStore ..> SimplePizzaFactory : uses
```

### 3.1.4 ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|
| å°†åˆ›å»ºé€»è¾‘é›†ä¸­ç®¡ç† | æ¯æ–°å¢äº§å“éƒ½è¦ä¿®æ”¹å·¥å‚ç±»ï¼ˆè¿å OCPï¼‰ |
| å®¢æˆ·ç«¯ä¸éœ€è¦çŸ¥é“å…·ä½“ç±»å | å·¥å‚ç±»èŒè´£è¿‡é‡ï¼ˆè¿å SRPï¼‰ |
| ä½¿ç”¨ç®€å•ï¼Œä»£ç ç›´è§‚ | å·¥å‚ç±»ä¸­çš„ switch/if-else ä»£ç å¯èƒ½å¾ˆé•¿ |

---

## 3.2 å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory Method Patternï¼‰

> **å®šä¹‰**ï¼šå®šä¹‰ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œä½†è®©å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸€ä¸ªç±»ã€‚å·¥å‚æ–¹æ³•è®©ç±»çš„å®ä¾‹åŒ–**æ¨è¿Ÿåˆ°å­ç±»**ã€‚

### 3.2.1 æ ¸å¿ƒæ€æƒ³

ç®€å•å·¥å‚çš„é—®é¢˜æ˜¯ï¼šæ¯æ–°å¢ä¸€ç§äº§å“éƒ½è¦ä¿®æ”¹å·¥å‚ç±»ã€‚å·¥å‚æ–¹æ³•æ¨¡å¼çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š**æŠŠåˆ›å»ºé€»è¾‘ä¸‹æ²‰åˆ°å­ç±»**ï¼Œæ¯ç§äº§å“å¯¹åº”ä¸€ä¸ªå·¥å‚ã€‚

### 3.2.2 å®ç°

```java
// äº§å“æ¥å£
public interface Pizza {
    void prepare();
    void bake();
    void cut();
    void box();
    String getName();
}

// å…·ä½“äº§å“
public class NYCheesePizza implements Pizza {
    @Override public String getName() { return "çº½çº¦é£å‘³å¥¶é…ª Pizza"; }
    @Override public void prepare() { System.out.println("å‡†å¤‡ " + getName() + " åŸæ–™"); }
    @Override public void bake() { System.out.println("çƒ˜çƒ¤ " + getName()); }
    @Override public void cut() { System.out.println("åˆ‡å‰² " + getName()); }
    @Override public void box() { System.out.println("åŒ…è£… " + getName()); }
}

public class ChicagoCheesePizza implements Pizza {
    @Override public String getName() { return "èŠåŠ å“¥é£å‘³å¥¶é…ª Pizza"; }
    @Override public void prepare() { System.out.println("å‡†å¤‡ " + getName() + " åŸæ–™"); }
    @Override public void bake() { System.out.println("çƒ˜çƒ¤ " + getName()); }
    @Override public void cut() { System.out.println("å¯¹è§’çº¿åˆ‡å‰² " + getName()); }
    @Override public void box() { System.out.println("åŒ…è£… " + getName()); }
}

// æŠ½è±¡å·¥å‚ï¼ˆå·¥å‚æ–¹æ³•æ¨¡å¼çš„æ ¸å¿ƒï¼‰
public abstract class PizzaStore {
    // å·¥å‚æ–¹æ³•ï¼šç”±å­ç±»å®ç°
    protected abstract Pizza createPizza(String type);
    
    // æ¨¡æ¿æ–¹æ³•ï¼šå®šä¹‰åˆ¶ä½œæµç¨‹
    public Pizza orderPizza(String type) {
        Pizza pizza = createPizza(type); // è°ƒç”¨å·¥å‚æ–¹æ³•
        System.out.println("--- åˆ¶ä½œ " + pizza.getName() + " ---");
        pizza.prepare();
        pizza.bake();
        pizza.cut();
        pizza.box();
        return pizza;
    }
}

// å…·ä½“å·¥å‚
public class NYPizzaStore extends PizzaStore {
    @Override
    protected Pizza createPizza(String type) {
        switch (type) {
            case "cheese": return new NYCheesePizza();
            case "pepperoni": return new NYPepperoniPizza();
            default: throw new IllegalArgumentException("çº½çº¦åº—ä¸æ”¯æŒ: " + type);
        }
    }
}

public class ChicagoPizzaStore extends PizzaStore {
    @Override
    protected Pizza createPizza(String type) {
        switch (type) {
            case "cheese": return new ChicagoCheesePizza();
            case "pepperoni": return new ChicagoPepperoniPizza();
            default: throw new IllegalArgumentException("èŠåŠ å“¥åº—ä¸æ”¯æŒ: " + type);
        }
    }
}
```

### 3.2.3 UML ç±»å›¾

```mermaid
classDiagram
    class Pizza {
        <<interface>>
        +prepare()
        +bake()
        +cut()
        +box()
        +getName() String
    }
    
    class NYCheesePizza {
        +getName() String
        +prepare()
        +bake()
        +cut()
        +box()
    }
    
    class ChicagoCheesePizza {
        +getName() String
        +prepare()
        +bake()
        +cut()
        +box()
    }
    
    class PizzaStore {
        <<abstract>>
        #createPizza(String type)* Pizza
        +orderPizza(String type) Pizza
    }
    
    class NYPizzaStore {
        #createPizza(String type) Pizza
    }
    
    class ChicagoPizzaStore {
        #createPizza(String type) Pizza
    }
    
    Pizza <|.. NYCheesePizza
    Pizza <|.. ChicagoCheesePizza
    PizzaStore <|-- NYPizzaStore
    PizzaStore <|-- ChicagoPizzaStore
    NYPizzaStore ..> NYCheesePizza : creates
    ChicagoPizzaStore ..> ChicagoCheesePizza : creates
```

### 3.2.4 ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|
| éµå¾ªå¼€é—­åŸåˆ™ï¼ˆæ–°å¢äº§å“åªéœ€æ–°å¢å·¥å‚å­ç±»ï¼‰ | æ¯å¢åŠ ä¸€ç§äº§å“å°±è¦å¢åŠ ä¸€ä¸ªå·¥å‚ç±»ï¼Œç±»çˆ†ç‚¸ |
| éµå¾ªå•ä¸€èŒè´£ï¼ˆæ¯ä¸ªå·¥å‚åªåˆ›å»ºä¸€ç§äº§å“ï¼‰ | å¢åŠ äº†ç³»ç»ŸæŠ½è±¡æ€§å’Œç†è§£éš¾åº¦ |
| å®¢æˆ·ç«¯åªä¾èµ–æŠ½è±¡ï¼Œä¸ä¾èµ–å…·ä½“ç±» | åªèƒ½ç”Ÿäº§ä¸€ç§äº§å“ï¼ˆä¸€ä¸ªæ–¹æ³•ï¼‰ |

---

## 3.3 æŠ½è±¡å·¥å‚æ¨¡å¼ï¼ˆAbstract Factory Patternï¼‰

> **å®šä¹‰**ï¼šæä¾›ä¸€ä¸ªåˆ›å»º**ä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡**çš„æ¥å£ï¼Œè€Œæ— éœ€æŒ‡å®šå®ƒä»¬çš„å…·ä½“ç±»ã€‚

### 3.3.1 äº§å“æ— vs äº§å“ç­‰çº§ç»“æ„

è¿™æ˜¯ç†è§£æŠ½è±¡å·¥å‚çš„å…³é”®æ¦‚å¿µï¼š

```mermaid
graph TB
    subgraph "äº§å“ç­‰çº§ç»“æ„ï¼ˆåŒä¸€ç±»äº§å“çš„ä¸åŒå®ç°ï¼‰"
        direction LR
        A1[MySQL è¿æ¥] --- A2[Oracle è¿æ¥] --- A3[PostgreSQL è¿æ¥]
    end
    
    subgraph "äº§å“æ—ï¼ˆåŒä¸€å“ç‰Œ/å¹³å°çš„ä¸€ç»„äº§å“ï¼‰"
        direction TB
        B1[MySQL è¿æ¥]
        B2[MySQL è¿æ¥æ± ]
        B3[MySQL äº‹åŠ¡ç®¡ç†å™¨]
    end
```

| æ¦‚å¿µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **äº§å“ç­‰çº§ç»“æ„** | åŒä¸€ç§äº§å“çš„ä¸åŒå®ç°ï¼ˆçºµå‘ï¼‰ | æ‰‹æœºäº§å“çº¿ï¼šåä¸ºæ‰‹æœºã€å°ç±³æ‰‹æœºã€è‹¹æœæ‰‹æœº |
| **äº§å“æ—** | åŒä¸€å“ç‰Œ/å¹³å°çš„ä¸€ç³»åˆ—äº§å“ï¼ˆæ¨ªå‘ï¼‰ | åä¸ºäº§å“æ—ï¼šåä¸ºæ‰‹æœºã€åä¸ºå¹³æ¿ã€åä¸ºç¬”è®°æœ¬ |

### 3.3.2 å®ç°

ä»¥è·¨æ•°æ®åº“çš„ DAO å±‚ä¸ºä¾‹ï¼š

```java
// ===== äº§å“æ¥å£ =====
// äº§å“Aï¼šè¿æ¥
public interface IConnection {
    void connect();
}

// äº§å“Bï¼šå‘½ä»¤
public interface ICommand {
    void execute(String sql);
}

// ===== å…·ä½“äº§å“ï¼ˆMySQL äº§å“æ—ï¼‰ =====
public class MySQLConnection implements IConnection {
    @Override
    public void connect() {
        System.out.println("å»ºç«‹ MySQL è¿æ¥");
    }
}

public class MySQLCommand implements ICommand {
    @Override
    public void execute(String sql) {
        System.out.println("MySQL æ‰§è¡Œ: " + sql);
    }
}

// ===== å…·ä½“äº§å“ï¼ˆOracle äº§å“æ—ï¼‰ =====
public class OracleConnection implements IConnection {
    @Override
    public void connect() {
        System.out.println("å»ºç«‹ Oracle è¿æ¥");
    }
}

public class OracleCommand implements ICommand {
    @Override
    public void execute(String sql) {
        System.out.println("Oracle æ‰§è¡Œ: " + sql);
    }
}

// ===== æŠ½è±¡å·¥å‚ =====
public interface IDatabaseFactory {
    IConnection createConnection();
    ICommand createCommand();
}

// ===== å…·ä½“å·¥å‚ï¼ˆMySQL å·¥å‚ â€”â€” ç”Ÿäº§ MySQL äº§å“æ—ï¼‰ =====
public class MySQLFactory implements IDatabaseFactory {
    @Override
    public IConnection createConnection() {
        return new MySQLConnection();
    }
    
    @Override
    public ICommand createCommand() {
        return new MySQLCommand();
    }
}

// ===== å…·ä½“å·¥å‚ï¼ˆOracle å·¥å‚ â€”â€” ç”Ÿäº§ Oracle äº§å“æ—ï¼‰ =====
public class OracleFactory implements IDatabaseFactory {
    @Override
    public IConnection createConnection() {
        return new OracleConnection();
    }
    
    @Override
    public ICommand createCommand() {
        return new OracleCommand();
    }
}

// ===== å®¢æˆ·ç«¯ =====
public class Application {
    private IConnection connection;
    private ICommand command;
    
    public Application(IDatabaseFactory factory) {
        this.connection = factory.createConnection();
        this.command = factory.createCommand();
    }
    
    public void run() {
        connection.connect();
        command.execute("SELECT * FROM users");
    }
}
```

### 3.3.3 UML ç±»å›¾

```mermaid
classDiagram
    class IConnection {
        <<interface>>
        +connect()
    }
    
    class ICommand {
        <<interface>>
        +execute(String sql)
    }
    
    class MySQLConnection {
        +connect()
    }
    
    class OracleConnection {
        +connect()
    }
    
    class MySQLCommand {
        +execute(String sql)
    }
    
    class OracleCommand {
        +execute(String sql)
    }
    
    class IDatabaseFactory {
        <<interface>>
        +createConnection() IConnection
        +createCommand() ICommand
    }
    
    class MySQLFactory {
        +createConnection() IConnection
        +createCommand() ICommand
    }
    
    class OracleFactory {
        +createConnection() IConnection
        +createCommand() ICommand
    }
    
    IConnection <|.. MySQLConnection
    IConnection <|.. OracleConnection
    ICommand <|.. MySQLCommand
    ICommand <|.. OracleCommand
    IDatabaseFactory <|.. MySQLFactory
    IDatabaseFactory <|.. OracleFactory
    MySQLFactory ..> MySQLConnection : creates
    MySQLFactory ..> MySQLCommand : creates
    OracleFactory ..> OracleConnection : creates
    OracleFactory ..> OracleCommand : creates
```

### 3.3.4 ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|
| ä¿è¯äº§å“æ—çš„ä¸€è‡´æ€§ï¼ˆä¸ä¼šæŠŠ MySQL è¿æ¥å’Œ Oracle å‘½ä»¤æ··æ­ï¼‰ | æ–°å¢äº§å“ï¼ˆå¦‚æ–°å¢ ITransactionï¼‰éœ€è¦ä¿®æ”¹æ‰€æœ‰å·¥å‚ï¼Œè¿å OCP |
| åˆ‡æ¢äº§å“æ—éå¸¸æ–¹ä¾¿ï¼ˆåªéœ€æ›´æ¢å·¥å‚å®ä¾‹ï¼‰ | ç±»çš„æ•°é‡å¢é•¿å¿« |
| å®¢æˆ·ç«¯ä¸å…·ä½“äº§å“è§£è€¦ | å½“äº§å“ç§ç±»è¾ƒå¤šæ—¶ï¼Œå·¥å‚æ¥å£ä¼šå˜å¾—è‡ƒè‚¿ |

---

## 3.4 ä¸‰ç§å·¥å‚æ¨¡å¼å¯¹æ¯”è¡¨

| ç»´åº¦ | ç®€å•å·¥å‚ | å·¥å‚æ–¹æ³• | æŠ½è±¡å·¥å‚ |
|------|---------|---------|---------|
| **å¤æ‚åº¦** | ä½ | ä¸­ | é«˜ |
| **æŠ½è±¡å±‚æ¬¡** | ä¸€ä¸ªå·¥å‚ç±» | ä¸€ä¸ªæŠ½è±¡å·¥å‚ + å¤šä¸ªå…·ä½“å·¥å‚ | ä¸€ä¸ªæŠ½è±¡å·¥å‚ + å¤šä¸ªå…·ä½“å·¥å‚ |
| **äº§å“æ•°é‡** | ä¸€ç§äº§å“ | ä¸€ç§äº§å“ | **å¤šç§äº§å“ï¼ˆäº§å“æ—ï¼‰** |
| **æ–°å¢äº§å“** | ä¿®æ”¹å·¥å‚ç±»ï¼ˆè¿å OCPï¼‰ | æ–°å¢å·¥å‚å­ç±»ï¼ˆéµå¾ª OCPï¼‰ | ä¿®æ”¹æŠ½è±¡å·¥å‚ï¼ˆè¿å OCPï¼‰ |
| **æ–°å¢äº§å“æ—** | â€” | â€” | æ–°å¢å·¥å‚å­ç±»ï¼ˆéµå¾ª OCPï¼‰ |
| **é€‚ç”¨åœºæ™¯** | äº§å“ç§ç±»å°‘ä¸”ç¨³å®š | äº§å“ç§ç±»å¤šï¼Œç»å¸¸æ‰©å±• | éœ€è¦åˆ›å»ºä¸€ç³»åˆ—ç›¸å…³äº§å“ |
| **GOF æ¨¡å¼** | âŒ ä¸å±äº | âœ… | âœ… |

---

## 3.5 Spring ä¸­çš„å·¥å‚æ¨¡å¼

### BeanFactory

`BeanFactory` æ˜¯ Spring å®¹å™¨çš„æ ¹æ¥å£ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªå…¸å‹çš„**å·¥å‚æ¨¡å¼**ã€‚

```mermaid
classDiagram
    class BeanFactory {
        <<interface>>
        +getBean(String name) Object
        +getBean(Class~T~ requiredType) T
    }
    
    class ApplicationContext {
        <<interface>>
    }
    
    class ClassPathXmlApplicationContext {
        +getBean(String name) Object
    }
    
    class AnnotationConfigApplicationContext {
        +getBean(String name) Object
    }
    
    BeanFactory <|-- ApplicationContext
    ApplicationContext <|.. ClassPathXmlApplicationContext
    ApplicationContext <|.. AnnotationConfigApplicationContext
    
    note for BeanFactory "Spring çš„æ ¸å¿ƒå·¥å‚æ¥å£\né€šè¿‡ getBean() åˆ›å»º/è·å–å¯¹è±¡\nå…¸å‹çš„å·¥å‚æ–¹æ³•æ¨¡å¼"
```

### FactoryBean

`FactoryBean` æ˜¯ Spring æä¾›çš„ä¸€ç§ç‰¹æ®Š Beanï¼Œå®ƒæœ¬èº«æ˜¯ä¸€ä¸ªå·¥å‚ï¼Œç”¨äºåˆ›å»º**å¤æ‚å¯¹è±¡**ï¼š

```java
public interface FactoryBean<T> {
    T getObject() throws Exception;       // åˆ›å»ºå¯¹è±¡
    Class<?> getObjectType();             // è¿”å›å¯¹è±¡ç±»å‹
    default boolean isSingleton() { return true; } // æ˜¯å¦å•ä¾‹
}

// ç¤ºä¾‹ï¼šMyBatis ä¸­çš„ SqlSessionFactoryBean
public class SqlSessionFactoryBean implements FactoryBean<SqlSessionFactory> {
    @Override
    public SqlSessionFactory getObject() throws Exception {
        // å¤æ‚çš„åˆ›å»ºé€»è¾‘...
        return new DefaultSqlSessionFactory(configuration);
    }
    
    @Override
    public Class<?> getObjectType() {
        return SqlSessionFactory.class;
    }
}
```

> **BeanFactory vs FactoryBean**ï¼š
> - `BeanFactory`ï¼šSpring å®¹å™¨çš„é¡¶å±‚æ¥å£ï¼Œæ˜¯**ç®¡ç† Bean çš„å·¥å‚**
> - `FactoryBean`ï¼šä¸€ä¸ª Bean æœ¬èº«å°±æ˜¯å·¥å‚ï¼Œæ˜¯**åˆ›å»ºç‰¹å®šå¯¹è±¡çš„å·¥å‚ Bean**

---

# å››ã€å»ºé€ è€…æ¨¡å¼ï¼ˆBuilderï¼‰

> **å®šä¹‰**ï¼šå°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å…¶è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚

## 4.1 ä»€ä¹ˆæ—¶å€™ç”¨å»ºé€ è€…æ¨¡å¼

- å¯¹è±¡æœ‰**å¾ˆå¤šå¯é€‰å‚æ•°**ï¼ˆæ„é€ å™¨å‚æ•°çˆ†ç‚¸é—®é¢˜ï¼‰
- å¯¹è±¡çš„**åˆ›å»ºè¿‡ç¨‹å¤æ‚**ï¼ˆéœ€è¦å¤šæ­¥éª¤ç»„è£…ï¼‰
- éœ€è¦**ä¸å¯å˜å¯¹è±¡**ï¼ˆæ„å»ºå®Œæˆåä¸å…è®¸ä¿®æ”¹ï¼‰

### æ„é€ å™¨å‚æ•°çˆ†ç‚¸é—®é¢˜

```java
// âŒ å‚æ•°è¿‡å¤šçš„æ„é€ å™¨ â€”â€” å¯è¯»æ€§æå·®
public class Computer {
    public Computer(String cpu, String ram, String ssd, String gpu, 
                    String mainboard, String power, String cooler,
                    String case_, boolean hasWifi, boolean hasBluetooth) {
        // ...
    }
}

// è°ƒç”¨æ—¶æ ¹æœ¬åˆ†ä¸æ¸…æ¯ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆ
Computer pc = new Computer("i9-13900K", "64GB", "2TB", "RTX4090",
                           "Z790", "1000W", "360æ°´å†·", "å…¨å¡”", true, true);
```

---

## 4.2 ç»å…¸å»ºé€ è€…æ¨¡å¼ï¼ˆDirector + Builderï¼‰

### 4.2.1 UML ç±»å›¾

```mermaid
classDiagram
    class Product {
        -String partA
        -String partB
        -String partC
        +show()
    }
    
    class Builder {
        <<abstract>>
        #Product product
        +buildPartA()*
        +buildPartB()*
        +buildPartC()*
        +getResult() Product
    }
    
    class ConcreteBuilderA {
        +buildPartA()
        +buildPartB()
        +buildPartC()
    }
    
    class ConcreteBuilderB {
        +buildPartA()
        +buildPartB()
        +buildPartC()
    }
    
    class Director {
        -Builder builder
        +construct() Product
    }
    
    Builder <|-- ConcreteBuilderA
    Builder <|-- ConcreteBuilderB
    Director o-- Builder
    Builder --> Product
```

### 4.2.2 å®ç°

```java
// äº§å“ç±»
public class Computer {
    private String cpu;
    private String ram;
    private String ssd;
    private String gpu;
    
    public void setCpu(String cpu) { this.cpu = cpu; }
    public void setRam(String ram) { this.ram = ram; }
    public void setSsd(String ssd) { this.ssd = ssd; }
    public void setGpu(String gpu) { this.gpu = gpu; }
    
    @Override
    public String toString() {
        return "Computer{cpu='" + cpu + "', ram='" + ram + 
               "', ssd='" + ssd + "', gpu='" + gpu + "'}";
    }
}

// æŠ½è±¡å»ºé€ è€…
public abstract class ComputerBuilder {
    protected Computer computer = new Computer();
    
    public abstract void buildCPU();
    public abstract void buildRAM();
    public abstract void buildSSD();
    public abstract void buildGPU();
    
    public Computer getResult() {
        return computer;
    }
}

// å…·ä½“å»ºé€ è€…Aï¼šæ¸¸æˆç”µè„‘
public class GamingComputerBuilder extends ComputerBuilder {
    @Override public void buildCPU() { computer.setCpu("i9-13900K"); }
    @Override public void buildRAM() { computer.setRam("64GB DDR5"); }
    @Override public void buildSSD() { computer.setSsd("2TB NVMe"); }
    @Override public void buildGPU() { computer.setGpu("RTX 4090"); }
}

// å…·ä½“å»ºé€ è€…Bï¼šåŠå…¬ç”µè„‘
public class OfficeComputerBuilder extends ComputerBuilder {
    @Override public void buildCPU() { computer.setCpu("i5-13400"); }
    @Override public void buildRAM() { computer.setRam("16GB DDR4"); }
    @Override public void buildSSD() { computer.setSsd("512GB SSD"); }
    @Override public void buildGPU() { computer.setGpu("é›†æˆæ˜¾å¡"); }
}

// æŒ‡æŒ¥è€…ï¼ˆDirectorï¼‰
public class ComputerDirector {
    private ComputerBuilder builder;
    
    public ComputerDirector(ComputerBuilder builder) {
        this.builder = builder;
    }
    
    // æŒ‡æŒ¥æ„å»ºè¿‡ç¨‹
    public Computer construct() {
        builder.buildCPU();
        builder.buildRAM();
        builder.buildSSD();
        builder.buildGPU();
        return builder.getResult();
    }
}

// ä½¿ç”¨
ComputerDirector director = new ComputerDirector(new GamingComputerBuilder());
Computer gamingPC = director.construct();
System.out.println(gamingPC);
// Computer{cpu='i9-13900K', ram='64GB DDR5', ssd='2TB NVMe', gpu='RTX 4090'}
```

---

## 4.3 é“¾å¼å»ºé€ è€…ï¼ˆLombok @Builder é£æ ¼ï¼‰â­

å®é™…å¼€å‘ä¸­æ›´å¸¸ç”¨çš„æ˜¯**é“¾å¼å»ºé€ è€…**ï¼ˆä¹Ÿå« Fluent Builderï¼‰ï¼Œä¸éœ€è¦ Directorï¼š

```java
public class Computer {
    private final String cpu;       // final ä¿è¯ä¸å¯å˜
    private final String ram;
    private final String ssd;
    private final String gpu;
    private final boolean hasWifi;
    private final boolean hasBluetooth;
    
    // ç§æœ‰æ„é€ å™¨ï¼Œåªèƒ½é€šè¿‡ Builder åˆ›å»º
    private Computer(Builder builder) {
        this.cpu = builder.cpu;
        this.ram = builder.ram;
        this.ssd = builder.ssd;
        this.gpu = builder.gpu;
        this.hasWifi = builder.hasWifi;
        this.hasBluetooth = builder.hasBluetooth;
    }
    
    // é™æ€å†…éƒ¨ç±» Builder
    public static class Builder {
        // å¿…é¡»å‚æ•°
        private final String cpu;
        private final String ram;
        
        // å¯é€‰å‚æ•°ï¼ˆè®¾ç½®é»˜è®¤å€¼ï¼‰
        private String ssd = "256GB";
        private String gpu = "é›†æˆæ˜¾å¡";
        private boolean hasWifi = true;
        private boolean hasBluetooth = false;
        
        // å¿…é¡»å‚æ•°é€šè¿‡æ„é€ å™¨ä¼ å…¥
        public Builder(String cpu, String ram) {
            this.cpu = cpu;
            this.ram = ram;
        }
        
        // æ¯ä¸ª setter è¿”å› thisï¼Œæ”¯æŒé“¾å¼è°ƒç”¨
        public Builder ssd(String ssd) {
            this.ssd = ssd;
            return this;
        }
        
        public Builder gpu(String gpu) {
            this.gpu = gpu;
            return this;
        }
        
        public Builder wifi(boolean hasWifi) {
            this.hasWifi = hasWifi;
            return this;
        }
        
        public Builder bluetooth(boolean hasBluetooth) {
            this.hasBluetooth = hasBluetooth;
            return this;
        }
        
        // æ„å»ºæœ€ç»ˆå¯¹è±¡
        public Computer build() {
            // å¯ä»¥åœ¨è¿™é‡Œåšå‚æ•°æ ¡éªŒ
            return new Computer(this);
        }
    }
    
    @Override
    public String toString() {
        return "Computer{cpu='" + cpu + "', ram='" + ram + "', ssd='" + ssd +
               "', gpu='" + gpu + "', wifi=" + hasWifi + ", bluetooth=" + hasBluetooth + "}";
    }
}

// ä½¿ç”¨ï¼ˆå¯è¯»æ€§æä½³ï¼‰
Computer gamingPC = new Computer.Builder("i9-13900K", "64GB DDR5")
        .ssd("2TB NVMe")
        .gpu("RTX 4090")
        .wifi(true)
        .bluetooth(true)
        .build();

Computer officePC = new Computer.Builder("i5-13400", "16GB DDR4")
        .build(); // å…¶ä»–å‚æ•°ä½¿ç”¨é»˜è®¤å€¼
```

### é“¾å¼å»ºé€ è€…çš„ UML ç±»å›¾

```mermaid
classDiagram
    class Computer {
        -final String cpu
        -final String ram
        -final String ssd
        -final String gpu
        -final boolean hasWifi
        -final boolean hasBluetooth
        -Computer(Builder builder)
        +toString() String
    }
    
    class Builder {
        -final String cpu
        -final String ram
        -String ssd
        -String gpu
        -boolean hasWifi
        -boolean hasBluetooth
        +Builder(String cpu, String ram)
        +ssd(String) Builder
        +gpu(String) Builder
        +wifi(boolean) Builder
        +bluetooth(boolean) Builder
        +build() Computer
    }
    
    Computer *-- Builder : inner class
    Builder ..> Computer : creates
    
    note for Builder "æ¯ä¸ª setter è¿”å› this\næ”¯æŒé“¾å¼è°ƒç”¨\nLombok @Builder çš„åŸç†"
```

---

## 4.4 å»ºé€ è€… vs å·¥å‚æ¨¡å¼

| ç»´åº¦ | å·¥å‚æ¨¡å¼ | å»ºé€ è€…æ¨¡å¼ |
|------|---------|-----------|
| **å…³æ³¨ç‚¹** | åˆ›å»º**å“ªç§**å¯¹è±¡ | **å¦‚ä½•**åˆ›å»ºå¯¹è±¡ï¼ˆæ„å»ºæ­¥éª¤ï¼‰ |
| **äº§å“å¤æ‚åº¦** | ç®€å•å¯¹è±¡ | å¤æ‚å¯¹è±¡ï¼ˆå¤šå±æ€§ã€å¤šæ­¥éª¤ï¼‰ |
| **åˆ›å»ºè¿‡ç¨‹** | ä¸€æ­¥å®Œæˆ | å¤šæ­¥éª¤ç»„è£… |
| **äº§å“å·®å¼‚** | ä¸åŒç±»å‹çš„å¯¹è±¡ | åŒä¸€ç±»å‹ä½†é…ç½®ä¸åŒçš„å¯¹è±¡ |
| **å®¢æˆ·ç«¯çŸ¥é“** | äº§å“ç±»å‹å³å¯ | äº§å“çš„å„ç§é…ç½®ç»†èŠ‚ |

> **å½¢è±¡æ¯”å–»**ï¼š
> - **å·¥å‚æ¨¡å¼**åƒç‚¹èœï¼šæˆ‘è¦ä¸€ä»½"é±¼é¦™è‚‰ä¸"ï¼ˆæŒ‡å®šç±»å‹ï¼Œå¨å¸ˆåšå¥½ç«¯ä¸Šæ¥ï¼‰
> - **å»ºé€ è€…æ¨¡å¼**åƒè‡ªåŠ©ç«é”…ï¼šæˆ‘è¦ç‰›è‚‰å· + è™¾æ»‘ + è±†è… + é‡‘é’ˆè‡...ï¼ˆè‡ªå·±é€‰é…æ–™ï¼Œä¸€æ­¥æ­¥ç»„è£…ï¼‰

---

## 4.5 å®é™…åº”ç”¨

### StringBuilder / StringBuffer

```java
// StringBuilder å°±æ˜¯å…¸å‹çš„å»ºé€ è€…æ¨¡å¼
String result = new StringBuilder()
    .append("Hello")
    .append(" ")
    .append("World")
    .append("!")
    .toString();
```

### OkHttp Request

```java
Request request = new Request.Builder()
    .url("https://api.example.com/users")
    .addHeader("Authorization", "Bearer token")
    .addHeader("Content-Type", "application/json")
    .post(requestBody)
    .build();
```

### Guava ImmutableList

```java
ImmutableList<String> list = ImmutableList.<String>builder()
    .add("a")
    .add("b")
    .add("c")
    .build();
```

### Lombok @Builder

```java
// ä½¿ç”¨ Lombok æ³¨è§£ï¼Œè‡ªåŠ¨ç”Ÿæˆ Builder ä»£ç 
@Builder
@Data
public class User {
    private String name;
    private int age;
    private String email;
}

// ä½¿ç”¨
User user = User.builder()
    .name("å¼ ä¸‰")
    .age(25)
    .email("zhangsan@example.com")
    .build();
```

### Spring Security é…ç½®

```java
@Override
protected void configure(HttpSecurity http) throws Exception {
    http
        .authorizeRequests()
            .antMatchers("/public/**").permitAll()
            .antMatchers("/admin/**").hasRole("ADMIN")
            .anyRequest().authenticated()
        .and()
        .formLogin()
            .loginPage("/login")
            .permitAll()
        .and()
        .logout()
            .permitAll();
}
```

---

# äº”ã€åŸå‹æ¨¡å¼ï¼ˆPrototypeï¼‰

> **å®šä¹‰**ï¼šç”¨ä¸€ä¸ªå·²ç»åˆ›å»ºå¥½çš„å®ä¾‹ä½œä¸ºåŸå‹ï¼Œé€šè¿‡å¤åˆ¶ï¼ˆå…‹éš†ï¼‰è¯¥åŸå‹å¯¹è±¡æ¥åˆ›å»ºä¸€ä¸ªå’ŒåŸå‹ä¸€æ ·çš„æ–°å¯¹è±¡ã€‚

## 5.1 ä»€ä¹ˆæ—¶å€™ç”¨åŸå‹æ¨¡å¼

- åˆ›å»ºå¯¹è±¡çš„æˆæœ¬æ¯”è¾ƒå¤§ï¼ˆå¦‚éœ€è¦ IO æ“ä½œã€æ•°æ®åº“è®¿é—®ã€ç½‘ç»œè¯·æ±‚ï¼‰
- éœ€è¦åˆ›å»ºå¤§é‡**ç›¸ä¼¼ä½†åˆä¸å®Œå…¨ç›¸åŒ**çš„å¯¹è±¡
- å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹å¤æ‚ï¼ˆå¤šå±‚åµŒå¥—ï¼‰

### UML ç±»å›¾

```mermaid
classDiagram
    class Prototype {
        <<interface>>
        +clone() Prototype
    }
    
    class ConcretePrototypeA {
        -String field1
        -int field2
        +clone() Prototype
    }
    
    class ConcretePrototypeB {
        -String field1
        -List~String~ list
        +clone() Prototype
    }
    
    Prototype <|.. ConcretePrototypeA
    Prototype <|.. ConcretePrototypeB
    
    note for Prototype "Java ä¸­é€šè¿‡å®ç°\nCloneable æ¥å£\né‡å†™ clone() æ–¹æ³•"
```

---

## 5.2 Cloneable æ¥å£ä¸ clone() æ–¹æ³•

Java ä¸­å®ç°åŸå‹æ¨¡å¼é€šå¸¸ä½¿ç”¨ `Cloneable` æ¥å£å’Œ `Object.clone()` æ–¹æ³•ï¼š

```java
public class Sheep implements Cloneable {
    private String name;
    private int age;
    
    public Sheep(String name, int age) {
        this.name = name;
        this.age = age;
    }
    
    @Override
    public Sheep clone() {
        try {
            return (Sheep) super.clone();
        } catch (CloneNotSupportedException e) {
            throw new RuntimeException(e);
        }
    }
    
    @Override
    public String toString() {
        return "Sheep{name='" + name + "', age=" + age + "}";
    }
}

// ä½¿ç”¨
Sheep dolly = new Sheep("å¤šåˆ©", 3);
Sheep clone1 = dolly.clone();
Sheep clone2 = dolly.clone();

System.out.println(dolly);   // Sheep{name='å¤šåˆ©', age=3}
System.out.println(clone1);  // Sheep{name='å¤šåˆ©', age=3}
System.out.println(dolly == clone1); // falseï¼ˆä¸åŒå¯¹è±¡ï¼‰
```

> **æ³¨æ„**ï¼šå¦‚æœæ²¡æœ‰å®ç° `Cloneable` æ¥å£å°±è°ƒç”¨ `clone()`ï¼Œä¼šæŠ›å‡º `CloneNotSupportedException`ã€‚`Cloneable` æ˜¯ä¸€ä¸ª**æ ‡è®°æ¥å£**ï¼ˆMarker Interfaceï¼‰ï¼Œå®ƒæœ¬èº«æ²¡æœ‰ä»»ä½•æ–¹æ³•ã€‚

---

## 5.3 æµ…æ‹·è´ vs æ·±æ‹·è´ â­â­â­â­

### 5.3.1 å›¾è§£

```mermaid
graph TB
    subgraph "æµ…æ‹·è´ Shallow Copy"
        A[åŸå§‹å¯¹è±¡<br/>name="å¼ ä¸‰"<br/>age=25] -->|clone| B[å…‹éš†å¯¹è±¡<br/>name="å¼ ä¸‰"<br/>age=25]
        A -->|å¼•ç”¨| C[Address å¯¹è±¡<br/>city="åŒ—äº¬"]
        B -->|å¼•ç”¨åŒä¸€ä¸ª| C
    end
    
    subgraph "æ·±æ‹·è´ Deep Copy"
        D[åŸå§‹å¯¹è±¡<br/>name="å¼ ä¸‰"<br/>age=25] -->|clone| E[å…‹éš†å¯¹è±¡<br/>name="å¼ ä¸‰"<br/>age=25]
        D -->|å¼•ç”¨| F[Address å¯¹è±¡<br/>city="åŒ—äº¬"]
        E -->|å¼•ç”¨æ–°çš„| G[Address å¯¹è±¡(å‰¯æœ¬)<br/>city="åŒ—äº¬"]
    end
    
    style C fill:#ffcdd2
    style F fill:#c8e6c9
    style G fill:#c8e6c9
```

### 5.3.2 æµ…æ‹·è´è¯¦è§£

**æµ…æ‹·è´**ï¼š`Object.clone()` çš„é»˜è®¤è¡Œä¸ºã€‚å¯¹äºåŸºæœ¬ç±»å‹å­—æ®µç›´æ¥å¤åˆ¶å€¼ï¼Œå¯¹äºå¼•ç”¨ç±»å‹å­—æ®µåªå¤åˆ¶å¼•ç”¨ï¼ˆæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼‰ã€‚

```java
public class Person implements Cloneable {
    private String name;
    private int age;
    private Address address; // å¼•ç”¨ç±»å‹
    
    // æ„é€ æ–¹æ³•çœç•¥
    
    @Override
    public Person clone() {
        try {
            return (Person) super.clone(); // æµ…æ‹·è´
        } catch (CloneNotSupportedException e) {
            throw new RuntimeException(e);
        }
    }
}

public class Address {
    private String city;
    private String street;
    // getter/setter çœç•¥
}

// éªŒè¯æµ…æ‹·è´é—®é¢˜
Person p1 = new Person("å¼ ä¸‰", 25, new Address("åŒ—äº¬", "é•¿å®‰è¡—"));
Person p2 = p1.clone();

System.out.println(p1.getAddress() == p2.getAddress()); // trueï¼æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡
p2.getAddress().setCity("ä¸Šæµ·"); // ä¿®æ”¹å…‹éš†å¯¹è±¡çš„åœ°å€
System.out.println(p1.getAddress().getCity()); // "ä¸Šæµ·"ï¼åŸå¯¹è±¡ä¹Ÿè¢«ä¿®æ”¹äº†ï¼ğŸš¨
```

### 5.3.3 æ·±æ‹·è´è¯¦è§£

**æ·±æ‹·è´**ï¼šä¸ä»…å¤åˆ¶å¯¹è±¡æœ¬èº«ï¼Œè¿˜é€’å½’å¤åˆ¶æ‰€æœ‰å¼•ç”¨ç±»å‹å­—æ®µæŒ‡å‘çš„å¯¹è±¡ï¼Œä½¿å¾—åŸå¯¹è±¡å’Œå…‹éš†å¯¹è±¡**å®Œå…¨ç‹¬ç«‹**ã€‚

#### æ–¹å¼ä¸€ï¼šé‡å†™ clone() æ–¹æ³•

```java
public class Person implements Cloneable {
    private String name;
    private int age;
    private Address address;
    
    @Override
    public Person clone() {
        try {
            Person cloned = (Person) super.clone();
            // å¯¹å¼•ç”¨ç±»å‹å­—æ®µä¹Ÿè¿›è¡Œ clone
            cloned.address = this.address.clone();
            return cloned;
        } catch (CloneNotSupportedException e) {
            throw new RuntimeException(e);
        }
    }
}

public class Address implements Cloneable {
    private String city;
    private String street;
    
    @Override
    public Address clone() {
        try {
            return (Address) super.clone();
        } catch (CloneNotSupportedException e) {
            throw new RuntimeException(e);
        }
    }
}
```

> **é—®é¢˜**ï¼šå¦‚æœå¯¹è±¡åµŒå¥—å±‚æ¬¡å¾ˆæ·±ï¼ˆå¦‚ A â†’ B â†’ C â†’ Dï¼‰ï¼Œéœ€è¦å±‚å±‚é‡å†™ clone()ï¼Œéå¸¸éº»çƒ¦ã€‚

#### æ–¹å¼äºŒï¼šé€šè¿‡åºåˆ—åŒ–å®ç°æ·±æ‹·è´ â­

```java
import java.io.*;

public class DeepCopyUtil {
    /**
     * é€šè¿‡åºåˆ—åŒ–å®ç°æ·±æ‹·è´
     * è¦æ±‚å¯¹è±¡åŠå…¶æ‰€æœ‰å¼•ç”¨çš„å¯¹è±¡éƒ½å®ç° Serializable æ¥å£
     */
    @SuppressWarnings("unchecked")
    public static <T extends Serializable> T deepCopy(T obj) {
        try {
            // å†™å…¥å­—èŠ‚æµ
            ByteArrayOutputStream bos = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(bos);
            oos.writeObject(obj);
            oos.close();
            
            // ä»å­—èŠ‚æµè¯»å–ï¼ˆåˆ›å»ºæ–°å¯¹è±¡ï¼‰
            ByteArrayInputStream bis = new ByteArrayInputStream(bos.toByteArray());
            ObjectInputStream ois = new ObjectInputStream(bis);
            T copy = (T) ois.readObject();
            ois.close();
            
            return copy;
        } catch (Exception e) {
            throw new RuntimeException("æ·±æ‹·è´å¤±è´¥", e);
        }
    }
}

// ä½¿ç”¨
Person p1 = new Person("å¼ ä¸‰", 25, new Address("åŒ—äº¬", "é•¿å®‰è¡—"));
Person p2 = DeepCopyUtil.deepCopy(p1);
System.out.println(p1.getAddress() == p2.getAddress()); // false âœ… å®Œå…¨ç‹¬ç«‹
```

#### æ–¹å¼ä¸‰ï¼šé€šè¿‡ JSON åºåˆ—åŒ–

```java
import com.google.gson.Gson;

public class JsonDeepCopy {
    private static final Gson gson = new Gson();
    
    public static <T> T deepCopy(T obj, Class<T> clazz) {
        String json = gson.toJson(obj);
        return gson.fromJson(json, clazz);
    }
}

// ä½¿ç”¨
Person p1 = new Person("å¼ ä¸‰", 25, new Address("åŒ—äº¬", "é•¿å®‰è¡—"));
Person p2 = JsonDeepCopy.deepCopy(p1, Person.class);
```

### 5.3.4 ä¸‰ç§æ·±æ‹·è´æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| **é‡å†™ clone()** | æ€§èƒ½æœ€å¥½ï¼Œä¸éœ€è¦é¢å¤–ä¾èµ– | åµŒå¥—å±‚æ¬¡æ·±æ—¶å¾ˆéº»çƒ¦ï¼Œå®¹æ˜“é—æ¼ |
| **åºåˆ—åŒ–** | ç®€å•é€šç”¨ï¼Œä¸éœ€è¦å±‚å±‚é‡å†™ | éœ€è¦å®ç° Serializableï¼Œæ€§èƒ½ç¨å·® |
| **JSON** | æœ€ç®€å•ï¼Œä¸éœ€è¦å®ç°ä»»ä½•æ¥å£ | éœ€è¦ç¬¬ä¸‰æ–¹åº“ï¼ˆGson/Jacksonï¼‰ï¼Œæ€§èƒ½æœ€å·®ï¼Œå¯èƒ½ä¸¢å¤±ç±»å‹ä¿¡æ¯ |

---

## 5.4 å®é™…åº”ç”¨

### JDK ä¸­çš„åŸå‹æ¨¡å¼

- `Object.clone()` â€” Java å†…ç½®çš„å…‹éš†æœºåˆ¶
- `ArrayList.clone()` â€” è¿”å›ä¸€ä¸ªæµ…æ‹·è´
- `HashMap.clone()` â€” è¿”å›ä¸€ä¸ªæµ…æ‹·è´
- `Date.clone()` â€” è¿”å›ä¸€ä¸ªç‹¬ç«‹çš„æ‹·è´

### Spring ä¸­çš„åŸå‹æ¨¡å¼

```java
// Spring Bean çš„ prototype ä½œç”¨åŸŸ
@Component
@Scope("prototype") // æ¯æ¬¡ getBean éƒ½ä¼šåˆ›å»ºæ–°å®ä¾‹
public class PrototypeBean {
    // ...
}

// ä½¿ç”¨
ApplicationContext context = new AnnotationConfigApplicationContext(AppConfig.class);
PrototypeBean bean1 = context.getBean(PrototypeBean.class);
PrototypeBean bean2 = context.getBean(PrototypeBean.class);
System.out.println(bean1 == bean2); // false
```

> **æ³¨æ„**ï¼šSpring çš„ `prototype` ä½œç”¨åŸŸè™½ç„¶å«"åŸå‹"ï¼Œä½†å®ƒå¹¶ä¸æ˜¯é€šè¿‡ `clone()` å®ç°çš„ï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½è°ƒç”¨æ„é€ æ–¹æ³•åˆ›å»ºæ–°å®ä¾‹ã€‚è¿™ä¸ GOF åŸå‹æ¨¡å¼çš„"é€šè¿‡å…‹éš†åˆ›å»º"æœ‰æ‰€åŒºåˆ«ã€‚

---

# å…­ã€åˆ›å»ºå‹æ¨¡å¼åœ¨ Spring/JDK ä¸­çš„åº”ç”¨æ€»ç»“

| æ¨¡å¼ | JDK ä¸­çš„åº”ç”¨ | Spring ä¸­çš„åº”ç”¨ |
|------|-------------|----------------|
| **å•ä¾‹** | `Runtime.getRuntime()` | Bean é»˜è®¤ scope=singletonï¼Œ`DefaultSingletonBeanRegistry` |
| **å•ä¾‹** | `System` ç±»ï¼ˆé™æ€æ–¹æ³•æ¨¡æ‹Ÿå•ä¾‹ï¼‰ | `ApplicationContext` å•ä¾‹å®¹å™¨ |
| **å·¥å‚æ–¹æ³•** | `Collection.iterator()` è¿”å›ä¸åŒè¿­ä»£å™¨ | `BeanFactory.getBean()` |
| **å·¥å‚æ–¹æ³•** | `NumberFormat.getInstance()` | `FactoryBean` æ¥å£ |
| **å·¥å‚æ–¹æ³•** | `Calendar.getInstance()` | `ProxyFactory` åˆ›å»ºä»£ç†å¯¹è±¡ |
| **æŠ½è±¡å·¥å‚** | `DocumentBuilderFactory`ï¼ˆXML è§£æï¼‰ | ä¸åŒæ•°æ®åº“çš„ `DataSource` å·¥å‚ |
| **æŠ½è±¡å·¥å‚** | `TransformerFactory` | `AbstractFactoryBean` ç³»åˆ— |
| **å»ºé€ è€…** | `StringBuilder` / `StringBuffer` | `BeanDefinitionBuilder` |
| **å»ºé€ è€…** | `Stream.Builder` | `UriComponentsBuilder` |
| **å»ºé€ è€…** | `Locale.Builder` | `ResponseEntity.BodyBuilder` |
| **å»ºé€ è€…** | â€” | Spring Security `HttpSecurity` é“¾å¼é…ç½® |
| **åŸå‹** | `Object.clone()` | `scope="prototype"` çš„ Bean |
| **åŸå‹** | `ArrayList.clone()` / `HashMap.clone()` | `@Scope("prototype")` |

### å…³é”®æ€»ç»“

```mermaid
graph LR
    A[åˆ›å»ºå‹æ¨¡å¼æ ¸å¿ƒç›®æ ‡] --> B[å°†å¯¹è±¡çš„åˆ›å»ºä¸ä½¿ç”¨è§£è€¦]
    
    B --> C[å•ä¾‹æ¨¡å¼<br/>æ§åˆ¶å®ä¾‹æ•°é‡]
    B --> D[å·¥å‚æ¨¡å¼<br/>å°è£…åˆ›å»ºé€»è¾‘]
    B --> E[å»ºé€ è€…æ¨¡å¼<br/>åˆ†æ­¥éª¤åˆ›å»ºå¤æ‚å¯¹è±¡]
    B --> F[åŸå‹æ¨¡å¼<br/>é€šè¿‡å¤åˆ¶åˆ›å»ºå¯¹è±¡]
    
    C --> G[é€‚ç”¨åœºæ™¯ï¼šå…¨å±€å”¯ä¸€<br/>é…ç½®ã€è¿æ¥æ± ã€ç¼“å­˜]
    D --> H[é€‚ç”¨åœºæ™¯ï¼šéœ€è¦æ ¹æ®<br/>æ¡ä»¶åˆ›å»ºä¸åŒå¯¹è±¡]
    E --> I[é€‚ç”¨åœºæ™¯ï¼šå¯¹è±¡å±æ€§å¤š<br/>åˆ›å»ºæ­¥éª¤å¤æ‚]
    F --> J[é€‚ç”¨åœºæ™¯ï¼šåˆ›å»ºæˆæœ¬é«˜<br/>å¤§é‡ç›¸ä¼¼å¯¹è±¡]
```

---

# ä¸ƒã€é¢è¯•é«˜é¢‘é—®é¢˜

## é¢˜ç›® 1ï¼šè¯·åˆ—ä¸¾ä½ çŸ¥é“çš„è®¾è®¡æ¨¡å¼ï¼Œå¹¶è¯´è¯´åœ¨é¡¹ç›®ä¸­ç”¨è¿‡å“ªäº›ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

GOF å®šä¹‰äº† 23 ç§è®¾è®¡æ¨¡å¼ï¼Œåˆ†ä¸ºä¸‰ç±»ï¼š
- **åˆ›å»ºå‹**ï¼ˆ5ç§ï¼‰ï¼šå•ä¾‹ã€å·¥å‚æ–¹æ³•ã€æŠ½è±¡å·¥å‚ã€å»ºé€ è€…ã€åŸå‹
- **ç»“æ„å‹**ï¼ˆ7ç§ï¼‰ï¼šé€‚é…å™¨ã€æ¡¥æ¥ã€ç»„åˆã€è£…é¥°å™¨ã€å¤–è§‚ã€äº«å…ƒã€ä»£ç†
- **è¡Œä¸ºå‹**ï¼ˆ11ç§ï¼‰ï¼šæ¨¡æ¿æ–¹æ³•ã€ç­–ç•¥ã€è§‚å¯Ÿè€…ã€è´£ä»»é“¾ã€å‘½ä»¤ã€è¿­ä»£å™¨ã€ä¸­ä»‹è€…ã€å¤‡å¿˜å½•ã€çŠ¶æ€ã€è®¿é—®è€…ã€è§£é‡Šå™¨

é¡¹ç›®ä¸­å¸¸ç”¨çš„ï¼š
1. **å•ä¾‹æ¨¡å¼**ï¼šSpring Bean é»˜è®¤å•ä¾‹ï¼Œå…¨å±€é…ç½®ç±»
2. **å·¥å‚æ¨¡å¼**ï¼šSpring çš„ BeanFactoryã€å„ç§ xxxFactory
3. **å»ºé€ è€…æ¨¡å¼**ï¼šLombok @Builderã€OkHttp Request æ„å»º
4. **ç­–ç•¥æ¨¡å¼**ï¼šæ”¯ä»˜æ–¹å¼é€‰æ‹©ï¼ˆå¾®ä¿¡/æ”¯ä»˜å®/é“¶è¡Œå¡ï¼‰
5. **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**ï¼šJdbcTemplateã€RestTemplate
6. **è§‚å¯Ÿè€…æ¨¡å¼**ï¼šSpring çš„äº‹ä»¶æœºåˆ¶ï¼ˆApplicationEventï¼‰
7. **ä»£ç†æ¨¡å¼**ï¼šSpring AOPï¼ˆJDK åŠ¨æ€ä»£ç† / CGLIBï¼‰

---

## é¢˜ç›® 2ï¼šå•ä¾‹æ¨¡å¼æœ‰å‡ ç§å®ç°æ–¹å¼ï¼Ÿå„è‡ªçš„ä¼˜ç¼ºç‚¹ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

ä¸»è¦æœ‰ 7 ç§å®ç°æ–¹å¼ï¼š

1. **é¥¿æ±‰å¼ï¼ˆé™æ€å¸¸é‡ï¼‰**ï¼šç±»åŠ è½½æ—¶åˆ›å»ºï¼Œçº¿ç¨‹å®‰å…¨ï¼Œä½†ä¸æ”¯æŒæ‡’åŠ è½½
2. **é¥¿æ±‰å¼ï¼ˆé™æ€ä»£ç å—ï¼‰**ï¼šåŒä¸Šï¼Œå¯ä»¥åšæ›´å¤šåˆå§‹åŒ–é€»è¾‘
3. **æ‡’æ±‰å¼ï¼ˆçº¿ç¨‹ä¸å®‰å…¨ï¼‰**ï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯èƒ½åˆ›å»ºå¤šä¸ªå®ä¾‹ï¼Œä¸æ¨è
4. **æ‡’æ±‰å¼ï¼ˆsynchronizedï¼‰**ï¼šçº¿ç¨‹å®‰å…¨ä½†æ¯æ¬¡è°ƒç”¨éƒ½åŠ é”ï¼Œæ€§èƒ½å·®
5. **DCL åŒé‡æ£€æŸ¥é”**ï¼šçº¿ç¨‹å®‰å…¨ + æ‡’åŠ è½½ + æ€§èƒ½å¥½ï¼Œæ³¨æ„å¿…é¡»åŠ  volatile
6. **é™æ€å†…éƒ¨ç±»**ï¼šåˆ©ç”¨ç±»åŠ è½½æœºåˆ¶å®ç°æ‡’åŠ è½½å’Œçº¿ç¨‹å®‰å…¨ï¼Œæ¨è
7. **æšä¸¾**ï¼šæœ€æ¨èï¼Œå¤©ç„¶é˜²åå°„ã€é˜²åºåˆ—åŒ–

---

## é¢˜ç›® 3ï¼šDCL åŒé‡æ£€æŸ¥é”ä¸­ä¸ºä»€ä¹ˆå¿…é¡»åŠ  volatileï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

å› ä¸º `instance = new Singleton()` ä¸æ˜¯åŸå­æ“ä½œï¼Œåœ¨ JVM å±‚é¢åˆ†ä¸‰æ­¥ï¼š
1. åˆ†é…å†…å­˜ç©ºé—´
2. åˆå§‹åŒ–å¯¹è±¡ï¼ˆè°ƒç”¨æ„é€ æ–¹æ³•ï¼‰
3. å°† instance æŒ‡å‘åˆ†é…çš„å†…å­˜

ç”±äº**æŒ‡ä»¤é‡æ’åº**ï¼Œæ­¥éª¤ 2 å’Œ 3 å¯èƒ½è¢«é‡æ’ä¸º 1â†’3â†’2ã€‚è¿™æ ·ï¼Œçº¿ç¨‹Aæ‰§è¡Œåˆ°æ­¥éª¤3æ—¶ï¼Œinstance å·²ç»é nullï¼Œä½†å¯¹è±¡å°šæœªåˆå§‹åŒ–ã€‚æ­¤æ—¶çº¿ç¨‹Båœ¨ç¬¬ä¸€æ¬¡æ£€æŸ¥æ—¶å‘ç° instance != nullï¼Œç›´æ¥è¿”å›äº†ä¸€ä¸ª**æœªå®Œæˆåˆå§‹åŒ–çš„å¯¹è±¡**ï¼Œå¯¼è‡´ NPE æˆ–ä¸å¯é¢„æœŸçš„è¡Œä¸ºã€‚

`volatile` é€šè¿‡æ’å…¥**å†…å­˜å±éšœ**ï¼Œç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼Œä¿è¯æ­¥éª¤ 1â†’2â†’3 çš„é¡ºåºæ‰§è¡Œã€‚åŒæ—¶ä¿è¯ instance çš„ä¿®æ”¹å¯¹å…¶ä»–çº¿ç¨‹**ç«‹å³å¯è§**ã€‚

---

## é¢˜ç›® 4ï¼šå¦‚ä½•ç ´åå•ä¾‹æ¨¡å¼ï¼Ÿå¦‚ä½•é˜²å¾¡ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

**ç ´åæ–¹å¼ä¸€ï¼šåå°„**
- é€šè¿‡ `Constructor.setAccessible(true)` è·å–ç§æœ‰æ„é€ å™¨ï¼Œè°ƒç”¨ `newInstance()` åˆ›å»ºæ–°å®ä¾‹
- **é˜²å¾¡**ï¼šåœ¨æ„é€ å™¨ä¸­æ·»åŠ æ£€æŸ¥ï¼ˆå¦‚æœå®ä¾‹å·²å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œæˆ–ä½¿ç”¨æšä¸¾ï¼ˆJVM å±‚é¢ç¦æ­¢åå°„åˆ›å»ºæšä¸¾å®ä¾‹ï¼‰

**ç ´åæ–¹å¼äºŒï¼šåºåˆ—åŒ–**
- å¯¹è±¡åºåˆ—åŒ–åå†ååºåˆ—åŒ–ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹
- **é˜²å¾¡**ï¼šæ·»åŠ  `readResolve()` æ–¹æ³•è¿”å›å•ä¾‹å®ä¾‹ï¼Œæˆ–ä½¿ç”¨æšä¸¾ï¼ˆæšä¸¾çš„åºåˆ—åŒ–ç”± JVM ç‰¹æ®Šå¤„ç†ï¼‰

**æœ€ä½³é˜²å¾¡æ–¹æ¡ˆ**ï¼šä½¿ç”¨**æšä¸¾å•ä¾‹**ï¼Œå®ƒä» JVM å±‚é¢åŒæ—¶é˜²å¾¡äº†åå°„å’Œåºåˆ—åŒ–æ”»å‡»ã€‚

---

## é¢˜ç›® 5ï¼šç®€å•å·¥å‚ã€å·¥å‚æ–¹æ³•ã€æŠ½è±¡å·¥å‚æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

| | ç®€å•å·¥å‚ | å·¥å‚æ–¹æ³• | æŠ½è±¡å·¥å‚ |
|---|---------|---------|---------|
| **å·¥å‚æ•°é‡** | ä¸€ä¸ªå·¥å‚ç±» | å¤šä¸ªå·¥å‚ç±» | å¤šä¸ªå·¥å‚ç±» |
| **äº§å“æ•°é‡** | ä¸€ç§äº§å“ | ä¸€ç§äº§å“ | å¤šç§äº§å“ï¼ˆäº§å“æ—ï¼‰ |
| **æ‰©å±•æ–¹å¼** | ä¿®æ”¹å·¥å‚ç±» | å¢åŠ å·¥å‚å­ç±» | å¢åŠ å·¥å‚å­ç±» |
| **å¼€é—­åŸåˆ™** | è¿å | éµå¾ª | æ–°å¢äº§å“æ—éµå¾ªï¼Œæ–°å¢äº§å“ç§ç±»è¿å |
| **å¤æ‚åº¦** | ä½ | ä¸­ | é«˜ |

- **ç®€å•å·¥å‚**é€‚åˆäº§å“ç§ç±»å°‘ä¸”ç¨³å®šçš„åœºæ™¯
- **å·¥å‚æ–¹æ³•**é€‚åˆäº§å“ç§ç±»ç»å¸¸å˜åŒ–ï¼Œéœ€è¦éµå¾ªå¼€é—­åŸåˆ™
- **æŠ½è±¡å·¥å‚**é€‚åˆéœ€è¦åˆ›å»ºä¸€ç³»åˆ—ç›¸å…³äº§å“ï¼ˆäº§å“æ—ï¼‰çš„åœºæ™¯

---

## é¢˜ç›® 6ï¼šå»ºé€ è€…æ¨¡å¼å’Œå·¥å‚æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

- **å·¥å‚æ¨¡å¼**å…³æ³¨çš„æ˜¯**åˆ›å»ºä»€ä¹ˆå¯¹è±¡**ï¼ˆäº§å“ç±»å‹ä¸åŒï¼‰ï¼Œä¸€æ­¥åˆ°ä½
- **å»ºé€ è€…æ¨¡å¼**å…³æ³¨çš„æ˜¯**å¦‚ä½•åˆ›å»ºå¯¹è±¡**ï¼ˆåˆ›å»ºæ­¥éª¤å’Œé…ç½®ä¸åŒï¼‰ï¼Œåˆ†æ­¥éª¤ç»„è£…

ä¸¾ä¾‹ï¼š
- å·¥å‚æ¨¡å¼ï¼šé€ æ±½è½¦ vs é€ è‡ªè¡Œè½¦ â€” ä¸åŒç±»å‹
- å»ºé€ è€…æ¨¡å¼ï¼šé€ ä¸€è¾†æ±½è½¦ï¼ˆé€‰å‘åŠ¨æœºã€é€‰è½®èƒã€é€‰å†…é¥°...ï¼‰ â€” åŒç±»å‹ä¸åŒé…ç½®

åœ¨å®é™…å¼€å‘ä¸­ï¼Œå»ºé€ è€…æ¨¡å¼å¸¸ç”¨äºè§£å†³"æ„é€ å™¨å‚æ•°çˆ†ç‚¸"é—®é¢˜ï¼ˆå¦‚ Lombok çš„ `@Builder`ï¼‰ï¼Œè€Œå·¥å‚æ¨¡å¼å¸¸ç”¨äºæ ¹æ®æ¡ä»¶åˆ›å»ºä¸åŒç±»å‹çš„å¯¹è±¡ã€‚

---

## é¢˜ç›® 7ï¼šä»€ä¹ˆæ˜¯æµ…æ‹·è´å’Œæ·±æ‹·è´ï¼Ÿå¦‚ä½•å®ç°æ·±æ‹·è´ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

**æµ…æ‹·è´**ï¼šå¤åˆ¶å¯¹è±¡æ—¶ï¼ŒåŸºæœ¬ç±»å‹å­—æ®µå¤åˆ¶å€¼ï¼Œå¼•ç”¨ç±»å‹å­—æ®µåªå¤åˆ¶å¼•ç”¨ï¼ˆæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼‰ã€‚Java çš„ `Object.clone()` é»˜è®¤æ˜¯æµ…æ‹·è´ã€‚

**æ·±æ‹·è´**ï¼šå¤åˆ¶å¯¹è±¡æ—¶ï¼Œé€’å½’å¤åˆ¶æ‰€æœ‰å¼•ç”¨ç±»å‹å­—æ®µæŒ‡å‘çš„å¯¹è±¡ï¼Œä½¿åŸå¯¹è±¡å’Œå…‹éš†å¯¹è±¡å®Œå…¨ç‹¬ç«‹ã€‚

**æ·±æ‹·è´çš„å®ç°æ–¹å¼**ï¼š
1. **é‡å†™ clone() æ–¹æ³•**ï¼šåœ¨ clone() ä¸­å¯¹æ¯ä¸ªå¼•ç”¨å­—æ®µä¹Ÿè°ƒç”¨ clone()ï¼Œæ€§èƒ½æœ€å¥½ä½†åµŒå¥—æ·±æ—¶å¾ˆéº»çƒ¦
2. **åºåˆ—åŒ–**ï¼šå°†å¯¹è±¡åºåˆ—åŒ–ä¸ºå­—èŠ‚æµå†ååºåˆ—åŒ–ï¼Œç®€å•é€šç”¨ä½†éœ€è¦å®ç° Serializable
3. **JSON è½¬æ¢**ï¼šå…ˆè½¬ JSON å­—ç¬¦ä¸²å†è§£æå›æ¥ï¼Œæœ€ç®€å•ä½†æ€§èƒ½æœ€å·®ï¼Œå¯èƒ½ä¸¢å¤±ç±»å‹ä¿¡æ¯

---

## é¢˜ç›® 8ï¼šSpring ä¸­çš„å•ä¾‹å’Œ GOF å•ä¾‹æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

1. **ä½œç”¨èŒƒå›´ä¸åŒ**ï¼š
   - GOF å•ä¾‹ï¼šä¸€ä¸ª ClassLoader ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹
   - Spring å•ä¾‹ï¼šä¸€ä¸ª IoC å®¹å™¨ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼ˆå¤šä¸ªå®¹å™¨å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹ï¼‰

2. **å®ç°æ–¹å¼ä¸åŒ**ï¼š
   - GOF å•ä¾‹ï¼šç§æœ‰æ„é€ å™¨ + é™æ€æ–¹æ³•ï¼ˆç±»è‡ªå·±æ§åˆ¶åˆ›å»ºï¼‰
   - Spring å•ä¾‹ï¼šé€šè¿‡å®¹å™¨ç®¡ç†ï¼ˆæ³¨å†Œè¡¨ + ConcurrentHashMap ç¼“å­˜ï¼‰

3. **åˆ›å»ºæ§åˆ¶ä¸åŒ**ï¼š
   - GOF å•ä¾‹ï¼šç±»è‡ªå·±æ§åˆ¶åˆ›å»ºè¿‡ç¨‹
   - Spring å•ä¾‹ï¼šç”± Spring å®¹å™¨æ§åˆ¶ï¼ˆæ§åˆ¶åè½¬ IoCï¼‰

---

## é¢˜ç›® 9ï¼šè¯·è¯´å‡º 7 å¤§è®¾è®¡åŸåˆ™ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

1. **å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰**ï¼šä¸€ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªèŒè´£
2. **å¼€é—­åŸåˆ™ï¼ˆOCPï¼‰**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
3. **é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆLSPï¼‰**ï¼šå­ç±»èƒ½æ›¿ä»£çˆ¶ç±»ï¼Œä¸”ä¸æ”¹å˜çˆ¶ç±»è¡Œä¸º
4. **ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰**ï¼šä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
5. **æ¥å£éš”ç¦»åŸåˆ™ï¼ˆISPï¼‰**ï¼šæ¥å£è¦å°è€Œç²¾ï¼Œä¸è¦å¤§è€Œå…¨
6. **è¿ªç±³ç‰¹æ³•åˆ™ï¼ˆLoDï¼‰**ï¼šæœ€å°‘çŸ¥è¯†åŸåˆ™ï¼Œåªä¸ç›´æ¥æœ‹å‹é€šä¿¡
7. **åˆæˆå¤ç”¨åŸåˆ™ï¼ˆCRPï¼‰**ï¼šä¼˜å…ˆä½¿ç”¨ç»„åˆ/èšåˆï¼Œè€Œéç»§æ‰¿

å…¶ä¸­**å¼€é—­åŸåˆ™**æ˜¯æœ€é‡è¦çš„ï¼Œå…¶ä»–åŸåˆ™éƒ½æ˜¯ä¸ºäº†æ›´å¥½åœ°å®ç°å¼€é—­åŸåˆ™ã€‚

---

## é¢˜ç›® 10ï¼šè¯´è¯´ä½ å¯¹å¼€é—­åŸåˆ™çš„ç†è§£ï¼Ÿä¸¾ä¸ªå®é™…ä¾‹å­ã€‚

**å‚è€ƒç­”æ¡ˆ**ï¼š

å¼€é—­åŸåˆ™çš„æ ¸å¿ƒæ˜¯**å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­**ã€‚å½“éœ€æ±‚å˜åŒ–æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥é€šè¿‡æ–°å¢ä»£ç æ¥å®ç°æ–°åŠŸèƒ½ï¼Œè€Œä¸æ˜¯ä¿®æ”¹å·²æœ‰ä»£ç ã€‚

**å®é™…ä¾‹å­**ï¼šæ”¯ä»˜ç³»ç»Ÿ

```java
// è¿åå¼€é—­åŸåˆ™
public class PayService {
    public void pay(String type, double amount) {
        if ("wechat".equals(type)) { /* å¾®ä¿¡æ”¯ä»˜ */ }
        else if ("alipay".equals(type)) { /* æ”¯ä»˜å®æ”¯ä»˜ */ }
        // æ–°å¢é“¶è¡Œå¡æ”¯ä»˜éœ€è¦ä¿®æ”¹æ­¤æ–¹æ³•
    }
}

// éµå¾ªå¼€é—­åŸåˆ™
public interface PayStrategy {
    void pay(double amount);
}

public class WechatPay implements PayStrategy { /* ... */ }
public class AlipayPay implements PayStrategy { /* ... */ }
// æ–°å¢é“¶è¡Œå¡æ”¯ä»˜ï¼šåªéœ€æ–°å¢ BankCardPay ç±»ï¼Œä¸ä¿®æ”¹ä»»ä½•å·²æœ‰ä»£ç 
public class BankCardPay implements PayStrategy { /* ... */ }
```

Spring ä¸­ä¹Ÿå¤§é‡è¿ç”¨äº†å¼€é—­åŸåˆ™ï¼Œæ¯”å¦‚é€šè¿‡ `BeanPostProcessor`ã€`HandlerInterceptor` ç­‰æ‰©å±•ç‚¹æ¥æ‰©å±•åŠŸèƒ½ï¼Œè€Œä¸æ˜¯ä¿®æ”¹æ¡†æ¶æºç ã€‚

---

## é¢˜ç›® 11ï¼šæšä¸¾å•ä¾‹ä¸ºä»€ä¹ˆèƒ½é˜²æ­¢åå°„å’Œåºåˆ—åŒ–ç ´åï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

**é˜²åå°„**ï¼š
- åœ¨ JDK çš„ `Constructor.newInstance()` æºç ä¸­ï¼Œæœ‰ä¸€ä¸ªæ˜ç¡®çš„æ£€æŸ¥ï¼šå¦‚æœæ˜¯æšä¸¾ç±»å‹ï¼Œç›´æ¥æŠ›å‡º `IllegalArgumentException("Cannot reflectively create enum objects")`
- è¿™æ˜¯ JVM å±‚é¢çš„ç¡¬ç¼–ç é™åˆ¶ï¼Œæ— æ³•ç»•è¿‡

**é˜²åºåˆ—åŒ–**ï¼š
- Java å¯¹æšä¸¾çš„åºåˆ—åŒ–åšäº†ç‰¹æ®Šå¤„ç†ï¼šåºåˆ—åŒ–æ—¶åªå†™å…¥æšä¸¾å¸¸é‡çš„åå­—ï¼ˆnameï¼‰
- ååºåˆ—åŒ–æ—¶é€šè¿‡ `Enum.valueOf()` æ–¹æ³•æŸ¥æ‰¾ï¼Œè¿”å›çš„æ˜¯å·²æœ‰çš„æšä¸¾å¸¸é‡ï¼Œä¸ä¼šåˆ›å»ºæ–°å®ä¾‹
- è¿™æ˜¯ Java åºåˆ—åŒ–è§„èŒƒä¸­çš„ç‰¹æ®Šçº¦å®š

è¿™ä¸¤ä¸ªæœºåˆ¶éƒ½æ˜¯ JVM/Java è¯­è¨€å±‚é¢çš„ä¿è¯ï¼Œæ‰€ä»¥æšä¸¾å•ä¾‹æ˜¯**æœ€å®‰å…¨**çš„å•ä¾‹å®ç°æ–¹å¼ã€‚

---

## é¢˜ç›® 12ï¼šä»€ä¹ˆæ˜¯äº§å“æ—å’Œäº§å“ç­‰çº§ç»“æ„ï¼ŸæŠ½è±¡å·¥å‚é€‚ç”¨äºä»€ä¹ˆåœºæ™¯ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

- **äº§å“ç­‰çº§ç»“æ„**ï¼šåŒä¸€ç±»äº§å“çš„ä¸åŒå®ç°ã€‚ä¾‹å¦‚ï¼šMySQL æ•°æ®åº“è¿æ¥ã€Oracle æ•°æ®åº“è¿æ¥ã€PostgreSQL æ•°æ®åº“è¿æ¥ â€” éƒ½æ˜¯"æ•°æ®åº“è¿æ¥"è¿™ä¸€äº§å“ç­‰çº§
- **äº§å“æ—**ï¼šåŒä¸€å“ç‰Œ/å¹³å°ä¸‹çš„ä¸€ç»„ä¸åŒäº§å“ã€‚ä¾‹å¦‚ï¼šMySQL è¿æ¥ + MySQL å‘½ä»¤ + MySQL äº‹åŠ¡ç®¡ç†å™¨ â€” éƒ½å±äº MySQL äº§å“æ—

**æŠ½è±¡å·¥å‚é€‚ç”¨åœºæ™¯**ï¼š
å½“ç³»ç»Ÿéœ€è¦åˆ›å»º**ä¸€ç³»åˆ—ç›¸å…³äº§å“**ï¼ˆäº§å“æ—ï¼‰ï¼Œä¸”è¿™äº›äº§å“å¿…é¡»é…å¥—ä½¿ç”¨æ—¶ã€‚ä¾‹å¦‚ï¼š
- è·¨æ•°æ®åº“çš„ DAO å±‚ï¼ˆè¿æ¥ + å‘½ä»¤ + äº‹åŠ¡å¿…é¡»æ˜¯åŒä¸€æ•°æ®åº“çš„ï¼‰
- è·¨å¹³å° UIï¼ˆæŒ‰é’® + æ–‡æœ¬æ¡† + ä¸‹æ‹‰æ¡†å¿…é¡»æ˜¯åŒä¸€é£æ ¼çš„ï¼‰
- å¤šå¥—æ¢è‚¤æ–¹æ¡ˆï¼ˆèƒŒæ™¯ + å›¾æ ‡ + å­—ä½“å¿…é¡»æ˜¯åŒä¸€ä¸»é¢˜çš„ï¼‰

æŠ½è±¡å·¥å‚çš„ä¼˜åŠ¿æ˜¯**ä¿è¯äº§å“æ—çš„ä¸€è‡´æ€§**ï¼Œä¸ä¼šå‡ºç°æ··æ­ï¼ˆå¦‚ç”¨ MySQL è¿æ¥æ‰§è¡Œ Oracle å‘½ä»¤ï¼‰ã€‚

---

## é¢˜ç›® 13ï¼šåœ¨ Spring ä¸­ï¼ŒBeanFactory å’Œ FactoryBean æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

- **BeanFactory**ï¼šæ˜¯ Spring å®¹å™¨çš„**é¡¶å±‚æ¥å£**ï¼Œå®šä¹‰äº†å®¹å™¨çš„åŸºæœ¬åŠŸèƒ½ï¼ˆ`getBean()`ã€`containsBean()` ç­‰ï¼‰ã€‚å®ƒæ˜¯**ç®¡ç†æ‰€æœ‰ Bean çš„å·¥å‚**ã€‚
  - å…¸å‹å®ç°ï¼š`DefaultListableBeanFactory`ã€`ClassPathXmlApplicationContext`
  - æ ¸å¿ƒæ–¹æ³•ï¼š`getBean(String name)` â€” æ ¹æ®åç§°è·å– Bean

- **FactoryBean**ï¼šæ˜¯ä¸€ä¸ª**ç‰¹æ®Šçš„ Bean**ï¼Œå®ƒæœ¬èº«æ˜¯ä¸€ä¸ªå·¥å‚ï¼Œç”¨äºåˆ›å»ºå¤æ‚å¯¹è±¡ã€‚å®ç° `FactoryBean<T>` æ¥å£åï¼ŒSpring å®¹å™¨è°ƒç”¨ `getObject()` æ–¹æ³•è·å–å®é™…çš„ Beanã€‚
  - å…¸å‹åº”ç”¨ï¼šMyBatis çš„ `SqlSessionFactoryBean`ã€ProxyFactoryBean
  - é€šè¿‡ `&` å‰ç¼€è·å– FactoryBean æœ¬èº«ï¼š`context.getBean("&myFactory")`

**ä¸€å¥è¯æ€»ç»“**ï¼š
- `BeanFactory` æ˜¯ Spring å®¹å™¨æœ¬èº«ï¼ˆç®¡ç† Bean çš„å·¥å‚ï¼‰
- `FactoryBean` æ˜¯å®¹å™¨ä¸­çš„ä¸€ä¸ª Beanï¼Œä½†è¿™ä¸ª Bean è‡ªèº«å°±æ˜¯ä¸€ä¸ªå·¥å‚ï¼ˆåˆ›å»ºç‰¹å®šå¯¹è±¡çš„å·¥å‚ Beanï¼‰

---

## é¢˜ç›® 14ï¼šå®é™…é¡¹ç›®ä¸­ä½ ä¼šå¦‚ä½•é€‰æ‹©åˆ›å»ºå‹æ¨¡å¼ï¼Ÿ

**å‚è€ƒç­”æ¡ˆ**ï¼š

æ ¹æ®éœ€æ±‚é€‰æ‹©ï¼š

1. **éœ€è¦å…¨å±€å”¯ä¸€å®ä¾‹** â†’ **å•ä¾‹æ¨¡å¼**
   - é…ç½®ç®¡ç†ã€è¿æ¥æ± ã€æ—¥å¿—è®°å½•å™¨

2. **éœ€è¦æ ¹æ®ç±»å‹/æ¡ä»¶åˆ›å»ºä¸åŒå¯¹è±¡** â†’ **å·¥å‚æ¨¡å¼**
   - äº§å“ç§ç±»å°‘ä¸”ç¨³å®š â†’ ç®€å•å·¥å‚
   - äº§å“ç§ç±»å¤šä¸”ç»å¸¸æ‰©å±• â†’ å·¥å‚æ–¹æ³•
   - éœ€è¦åˆ›å»ºä¸€ç³»åˆ—é…å¥—äº§å“ â†’ æŠ½è±¡å·¥å‚

3. **å¯¹è±¡å±æ€§å¾ˆå¤šä¸”æœ‰å¯é€‰å‚æ•°** â†’ **å»ºé€ è€…æ¨¡å¼**
   - æ„é€ å™¨å‚æ•°è¶…è¿‡ 4 ä¸ªæ—¶è€ƒè™‘ä½¿ç”¨
   - éœ€è¦ä¸å¯å˜å¯¹è±¡æ—¶

4. **åˆ›å»ºå¯¹è±¡æˆæœ¬å¤§ä¸”å¯¹è±¡ä¹‹é—´å·®å¼‚å°** â†’ **åŸå‹æ¨¡å¼**
   - æ‰¹é‡åˆ›å»ºç›¸ä¼¼å¯¹è±¡
   - å¯¹è±¡åˆ›å»ºéœ€è¦å¤§é‡ IO æˆ–è®¡ç®—

åœ¨å®é™…çš„ Spring é¡¹ç›®ä¸­ï¼Œå¤§éƒ¨åˆ†åˆ›å»ºé€»è¾‘éƒ½äº¤ç»™äº† Spring å®¹å™¨ç®¡ç†ï¼Œå¼€å‘è€…æ›´å¤šæ˜¯é€šè¿‡é…ç½®æ¥åˆ©ç”¨è¿™äº›æ¨¡å¼ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨å®ç°ã€‚

---

> **è¯¾ä»¶ç»“æŸ**ã€‚å»ºè®®é…åˆ `code/` ç›®å½•ä¸‹çš„å®éªŒä»£ç ä¸€èµ·å­¦ä¹ ï¼ŒåŠ¨æ‰‹å®è·µæ•ˆæœæ›´å¥½ã€‚
